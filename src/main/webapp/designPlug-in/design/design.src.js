$.extend({
    FormData: [{
        id: "defineCode",
        name: "表单编码",
        type: "text",
        sType: "readonly",
        fieldShowType:[""],
        defvalue: ""
    }, {
        id: "defineName",
        name: "表单名称",
        type: "text",
        sType: "show",
        fieldShowType:[""],
        defvalue: ""
    }, {
        id: "cssType",
        name: "表单样式",
        type: "select",
        sType: "show",
        fieldShowType:[""],
        defvalue: "",
    	subs: [{
                id: "",
                name: "通用",
                va: "TY"
            },{
                id: "",
                name: "公文",
                va: "GW"
            }]
    }, {
        id: "saveType",
        name: "保存方式",
        type: "select",
        sType: "show",
        fieldShowType:[""],
        defvalue: "",
    	subs: [{
            id: "",
            name: "键值保存",
            va: "2"
        },{
                id: "",
                name: "建表保存",
                va: "1"
            }]
    }, {
        id: "remark",
        name: "描述",
        type: "textarea",
        sType: "show",
        fieldShowType:[""],
        defvalue: ""
    }], /* 表单信息*/
    Fields: [{
        id: "id",
        name: "id",
        type: "",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs: []
    }, {
        id: "fieldName",
        name: "字段名称",
        type: "text",
        sType: "readonly",
        defvalue: "",
        fieldShowType:["*"],
        subs: []
    }, {
        id: "content",
        name: "显示名称",
        type: "text",
        sType: "",
        defvalue: "标题",
        fieldShowType:["*"],
        subs: []
    }, {
        id: "fieldAlert",
        name: "默认提示语",
        type: "text",
        sType: "",
        defvalue: "默认提示语",
        fieldShowType:["text","list","password","radio","checkbox","year","yymm","date","datetime","time","textarea","popup"],
        subs: []
    }, {
        id: "fieldDefault",
        name: "字段默认值",
        type: "select",
        sType: "",/*text","list","password","radio","checkbox","year","yymm","date","datetime","time","textarea","popup*/
        defvalue: "字段默认值",
        fieldShowType:["text","list","password","radio","checkbox","year","yymm","date","datetime","time","textarea","popup"],
        subs: [{
            id: "",
            name: "非默认字段",
            va: ""
        },{
            id: "",
            name: "草稿",
            va: "status"
        },{
            id: "",
            name: "当前系统时间",
            va: "createDate"
        }, {
            id: "",
            name: "系统登录用户编码",
            va: "createBy"
        }, {
            id: "",
            name: "系统登录用户名称",
            va: "createName"
        }, {
            id: "",
            name: "当前用户所在部门id",
            va: "orgId"
        }, {
            id: "",
            name: "当前用户所在部门名称",
            va: "orgName"
        }]
    }, {
        id: "fieldRemark",
        name: "字段备注",
        type: "text",
        sType: "",
        fieldShowType:[""],
        defvalue: "字段备注",
        subs: []
    }, {
        id: "orderNum",
        name: "字段排序",
        type: "text",
        sType: "",
        fieldShowType:[""],
        defvalue: "",
        subs: []
    },{
        id: "isProcessVariables",
        name: "流程变量",
        type: "select",
        sType: "",/*text","list","password","radio","checkbox","year","yymm","date","datetime","time","textarea","popup*/
        fieldShowType:[""],
        defvalue: "",
        subs: [{
            id: "",
            name: "不作为变量",
            va: ""
        },{
            id: "",
            name: "String变量",
            va: "S"
        }, {
            id: "",
            name: "Integer变量",
            va: "N"
        }, {
            id: "",
            name: "Long变量",
            va: "L"
        }, {
            id: "",
            name: "Date变量",
            va: "D"
        }, {
            id: "",
            name: "Boolean变量",
            va: "B"
        }]
    }, {
        id: "length",
        name: "字段长度",
        type: "text",
        sType: "",
        fieldShowType:[""],
        defvalue: "",
        subs: []
    }, {
        id: "type",
        name: "字段类型",
        type: "text",
        sType: "",
        fieldShowType:[""],
        defvalue: "",
        subs: []
    }, {
        id: "showType",
        name: "控件类型",
        type: "select",
        sType: "",
        fieldShowType:[""],
        defvalue: "",
        subs: [
            { id : "", name : "文本框", va : "text" } ,
            { id : "", name : "密码",va : "password" },
             { id : "", name : "单选", va : "radio" },
             { id :"", name : "多选", va : "checkbox" },
             { id : "", name : "时间", va :"date" },
             { id : "", name : "时分秒时间", va : "datetime" },
             { id : "",name : "下拉列表", va : "list" },
             { id : "", name : "弹出框", va :"popup" }
        ]
    }, {
        id: "isShowList",
        name: "列表显示",
        type: "select",
        sType: "",
        fieldShowType:[""],
        defvalue: "",
        subs: [{
            id: "",
            name: "是",
            va: "Y"
        }, {
            id: "",
            name: "否",
            va: "N"
        }]
    }, {
        id: "isImagelist",
        name: "是否图文显示",
        type: "select",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs: [{
            id: "",
            name: "是",
            va: "Y"
        }, {
            id: "",
            name: "否",
            va: "N"
        }]
    }, {
        id: "isEdit",
        name: "是否能编辑",
        type: "select",
        sType: "",
        defvalue: "",
        fieldShowType:["text","list","password","v_formFile","v_formFileByGroup","v_formPic","radio","checkbox","year","yymm","date","datetime","time","textarea","popup"],
        subs: [{
            id: "",
            name: "是",
            va: "Y"
        }, {
            id: "",
            name: "否",
            va: "N"
        }]
    }, {
        id: "isShow",
        name: "表单显示",
        type: "select",
        sType: "",
        defvalue: "",/*text","list","password","radio","checkbox","year","yymm","date","datetime","time","textarea","popup*/
        fieldShowType:[""],
        subs: [{
            id: "",
            name: "是",
            va: "Y"
        }, {
            id: "",
            name: "否",
            va: "N"
        }]
    }, {
        id: "isNotnull",
        name: "是否必填",
        type: "select",
        sType: "",
        fieldShowType:["text","list","password","radio","checkbox","year","yymm","date","datetime","time","textarea","popup"],
        defvalue: "",
        subs: [{
            id: "",
            name: "是",
            va: "Y"
        }, {
            id: "",
            name: "否",
            va: "N"
        }]
    }, {
        id: "isQuery",
        name: "是否查询",
        type: "select",
        sType: "",
        fieldShowType:[""],
        defvalue: "",
        subs: [{
            id: "",
            name: "是",
            va: "Y"
        }, {
            id: "",
            name: "否",
            va: "N"
        }]
    }, {
        id: "isFormHide",
        name: "表单是否隐藏",
        type: "select",
        sType: "",/*text","list","password","radio","checkbox","year","yymm","date","datetime","time","textarea","popup*/
        fieldShowType:[""],
        defvalue: "",
        subs: [{
            id: "",
            name: "是",
            va: "Y"
        }, {
            id: "",
            name: "否",
            va: "N"
        }]
    }, {
        id: "isSimple",
        name: "是否简明显示",
        type: "select",
        sType: "",
        fieldShowType:[""],
        defvalue: "",
        subs: [{
            id: "",
            name: "是",
            va: "Y"
        }, {
            id: "",
            name: "否",
            va: "N"
        }]
    }, {
        id: "pointLength",
        name: "小数点",
        type: "text",
        sType: "",
        fieldShowType:[""],
        defvalue: "",
        subs: []
    }, {
        id: "fieldHref",
        name: "选择数据来源",
        type: "select",
        sType: "",
        defvalue: "",
        fieldShowType:["popup","radio","checkbox","list","v_formFileByGroup"],
        selfFunction:"getSelectList",
        subs:[]
    },{
        id: "indexExtId",
        name: "指标id",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs:[]
    },{
        id: "defineId",
        name: "业务定义id",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs:[]
    }, {
        id: "windowWidth",
        name: "弹窗宽度",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs:[]
    }, {
        id: "windowHeight",
        name: "弹窗高度",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs:[]
    }, {
        id: "inputId",
        name: "赋值属性",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs:[]
    }, {
        id: "selectId",
        name: "选择属性",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs:[]
    }, {
        id: "wherePara",
        name: "过滤条件",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs:[]
    }, {
        id: "dictTable",
        name: "字典Table",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs: []
    }, {
        id: "dictField",
        name: "字典Code",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs: []
    }, {
        id: "dictText",
        name: "字典Text",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs: []
    }, {
        id: "fieldLength",
        name: "控件长度",
        type: "hidden",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs: []
    }, {
        id: "fieldValidType",
        name: "校验规则",
        type: "select",
        sType: "",
        defvalue: "",
        fieldShowType:["text","list","password","radio","checkbox","year","yymm","date","datetime","time","textarea","popup"],
        subs: [
               {id: "",name: "不验证",va: ""},
            {id: "",name: "任意字符",va: "*"},
            {id: "",name: "6到16位任意字符",va: "*6-16"},
            {id: "",name: "数字",va: "n"},
            {id: "",name: "数字(小数点)",va: "/^[0-9]+\.?[0-9]*$/"},
            {id: "",name: "6到16位数字", va: "n6-16"}, 
            {id: "",name: "不能输入特殊字符",va: "s"},
	        {id: "",name: "6到18位字符", va: "s6-18"}, 
	        {id: "",name: "邮政编码", va: "p"},
	        {id: "",name: "手机号码",va: "m"},
	        {id: "",name: "电话号码",va: "/^[0-9\-]{6,}$/"},
	        {id: "",name: "邮箱地址",va: "e"},
	        {id: "",name: "网址",va: "url"}
	        ]
    }, {
        id: "linkBussCode",
        name: "关联业务编码",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:["v_formDetailed"],
        subs: []
    }, {
        id: "bussCode",
        name: "业务编码",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs: []
    }, {
        id: "mainTable",
        name: "主表名",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs: []
    }, {
        id: "mainField",
        name: "关联主表字段",
        type: "text",
        sType: "",
        defvalue: "id",
        fieldShowType:["v_formDetailed"],
        subs: []
    }, {
        id: "detailField",
        name: "明细表字段",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:["v_formDetailed"],
        subs: []
    }, {
        id: "tableId",
        name: "headIed",
        type: "text",
        sType: "",
        defvalue: "",
        fieldShowType:[""],
        subs: []
    }], /* 从数据库加载过来的字段*/
    FieldsMap: {}, /* 控件属性map，每个控件id为key，其他属性为对象；*/
    FormDataMap: {}, /*表单map，每个控件id为key，其他属性为对象；*/
    Titles: [{
        id: "titleName",
        name: "标题",
        type: "text",
        defvalue: "标题",
        subs: []
    }, {
        id: "fontSize",
        name: "字体大小",
        type: "text",
        defvalue: "",
        subs: []
    }, {
        id: "fontColor",
        name: "字体颜色",
        type: "text",
        defvalue: "",
        subs: []
    }], /* 标题对象*/
    TitlesMap: {}, /* 控件属性map，每个控件id为key，其他属性为对象；*/
    ExtFields: {
        select: [{
            id: "selectSet",
            name: "selectSet",
            type: "selectSet",
            defvalue: "",
            subs: [{
                id: "",
                name: "选项1",
                va: "1"
            }, {
                id: "",
                name: "选项2",
                va: "2"
            }, {
                id: "",
                name: "选项3",
                va: "3"
            }]
        }]
    }, /* 从数据库加载过来的字段*/
    isEdit: true, /* 是否是编辑模式*/
    businessCode: "",
    versionNum: "",
    bussTemplateId: "",
    releaseCode: "",
    mainId: "",
    designform:null,
    widgets_:null,
    widgets_hide:null,
    configformId:"",
    getDesignHtml: function(designId, type) {
        var x = new Object();
        switch (type) {
            case 'input':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'text':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'textarea':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 2;
                x.width = 12;
                break;
            case 'select':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'list':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'checkbox':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'radio':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'datetime':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'time':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'year':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'yymm':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'date':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'v_formPic':
                x.fieldsHtmls = $.getDesignVFormPicHtml(designId, type);
                x.height = 6;
                x.width = 12;
                break;
            case 'v_formFile':
                x.fieldsHtmls = $.getDesignMyFileHtml(designId, type);
                x.height = 6;
                x.width = 12;
                break;
            case 'v_formFileByGroup':
                x.fieldsHtmls = $.getDesignMyGroupFileHtml(designId, type);
                x.height = 6;
                x.width = 12;
                break;
            case 'v_formButton':
                x.fieldsHtmls = $.getDesignButtonHtml(designId, type);
                x.height = 1;
                x.width = 1;
                break;
            case 'v_formGroupButton':
                x.fieldsHtmls = $.getDesignGroupButtonHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'v_formSaveButton':
                x.fieldsHtmls = $.getDesignSaveButtonHtml(designId, type);
                x.height = 1;
                x.width = 1;
                break;
            case 'v_formSubmitButton':
                x.fieldsHtmls = $.getDesignSubmitButtonHtml(designId, type);
                x.height = 1;
                x.width = 1;
                break;
            case 'v_formCloseButton':
                x.fieldsHtmls = $.getDesignCloseButtonHtml(designId, type);
                x.height = 1;
                x.width = 1;
                break;
            case 'v_formTitle':
                x.fieldsHtmls = $.getDesignFormTitleHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'v_formOffice':
                x.fieldsHtmls = $.getDesignOfficeHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'v_formGroupingTitle':
                x.fieldsHtmls = $.getDesignHeaderHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'v_formDescribeText':
                x.fieldsHtmls = $.getDesignMswzHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'popup':
                x.fieldsHtmls = $.getDesignFieldsHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
            case 'v_formDetailed':
                x.fieldsHtmls = $.getDetailListHtml1(designId, type);
                x.height = 3;
                x.width = 12;
                break;
            case 'v_formDetailedTab':
                x.fieldsHtmls = $.getDetailListTabHtml(designId, type);
                x.height = 9;
                x.width = 12;
                break;
            case 'v_formLabel':
                x.fieldsHtmls = $.getLabelHtml(designId, type);
                x.height = 4;
                x.width = 1;
                break;
            case 'v_formRegion':
                x.fieldsHtmls = $.getRegionHtml(designId, type);
                x.height = 1;
                x.width = 12;
                break;
        }
        return x;
    },
    sortDObject: function() {
        $(".ui-draggable").each(function(index) {
            var el = $(this);
            try {
                if ($.FieldsMap[el.attr('data-gs-design-id')]) {
                    $.FieldsMap[el.attr('data-gs-design-id')]["x"] = parseInt(el.attr('data-gs-x'));
                    $.FieldsMap[el.attr('data-gs-design-id')]["y"] = parseInt(el.attr('data-gs-y'));
                    $.FieldsMap[el.attr('data-gs-design-id')]["width"] = parseInt(el.attr('data-gs-width'));
                    $.FieldsMap[el.attr('data-gs-design-id')]["height"] = parseInt(el.attr('data-gs-height'));
                }
            } catch (e) {}
        });
    },
    getDObject: function() {
    	 var actLength=0;
         try{actLength=$("#processNodeActionBtn div").length;}catch(e){}
         var isTask=false;
    	if(actLength>0||$.isEnd=="true"){isTask=true;}
        var urlSt =  "designController.do?getJson&isTask="+isTask+"&showType=show&businessCode=" + $.businessCode + "&bussTemplateId=" + $.bussTemplateId + "&versionNum=" + $.versionNum;
        $.ajax({
            async: false,
            cache: false,
            type: 'GET',
            url: urlSt, /* 请求的action路径*/
            error: function() { /* 请求失败处理函数*/
            },
            success: function(data) {
                /* console.log(data);*/
                /**
                 * var hasD = "DObject" in data; if (hasD) { var d =
                 * $.parseJSON(data.DObject); $.FieldsMap = d.FieldsMap;
                 * $.Fields = d.Fields; $.Titles = d.Titles; $.isEdit =
                 * isEdit; } else {
                 */
                var x1_ = 0;
                $.FormDataMap = data.tSConfigform;
                
                /*var head = document.getElementsByTagName('head')[0];
            	var css_1 = document.createElement('link');
            	css_1.rel = 'stylesheet';
            	css_1.href = 'designPlug-in/template/'+($.FormDataMap.cssType==null||$.FormDataMap.cssType==""?"TY":$.FormDataMap.cssType)+'.css';
            	head.appendChild(css_1);*/
                
                
                /*console.log("$.FormDataMap-----------");*/
                /*console.log($.FormDataMap);*/
                var designBusinessDMap = data.designBusinessDMap;
                var designBusinessMList = data.designBusinessMList;
                console.log("----------------designBusinessDMap");
                console.log(designBusinessDMap);
                    var designBusinessDList = designBusinessDMap[designBusinessMList.id];
                    $(designBusinessDList).each(function(index1, obj1) {
                        var has = obj1.id in $.FieldsMap;
                        /* if (x1_ == 12) {
                         x1_ = 0;
                         }
                         obj1["x"] = x1_;
                         obj1["y"] = 1;
                         if (obj1.showType == "textarea") {
                         obj1["height"] = 2;
                         obj1["width"] = 12;
                         } else {
                         obj1["height"] = 1;
                         obj1["width"] = 3;
                         }
                        */
                        obj1["design_id"] = obj1.id;
                        obj1["auto_position"] = false;
                        /* x1_ = x1_ + 3;*/
                        if (!has) {
                            $.FieldsMap[obj1.id] = obj1;
                            if($.isEnd=="true"){
                            	$.FieldsMap[obj1.id]["isEdit"] = "N";
                            }
                        }
                        
                    });
                /* }*/
            }
        });
    },
    initAttchDrapDrop: function(fieldName) {
    	$("#goal_tab_attachmen_type_"+fieldName).find(".crumbs-nav-item").draggable({
			revert:true,
			revertDuration: 0,
			deltaX:0,
			deltaY:0,
            proxy: "clone"
		});
    	
    	$("#goal_tab_attachmen_type_"+fieldName).find(".attchDropDiv").droppable({
			accept:"#goal_tab_attachmen_type_"+fieldName+" .crumbs-nav-item",
			activeClass: "ui-state-hover",
			hoverClass: "ui-state-active",
			drop:function(event, ui){
				if($(event.target).attr("id")!=$(ui.draggable).parent().attr("id")){/*拖拽到不同的行才进行处理*/
					/*后台修改类型和类型名称*/
					var newAttchTypeCode = $(event.target).attr("typecode");
					var oldAttchId = $(ui.draggable).find("#attchtype_id").val();
					console.log(event);
					console.log(ui);
					$.ajax({
						type: "POST",
						url:"cgformAttchController.do?updateFileType",
						data:{id:oldAttchId,infotypeid:newAttchTypeCode},
						success:function (data){
							var dataObj=data;/*转换为json对象*/
							if(dataObj.msg==""){
							}else{
								tip(dataObj.msg);
							}
						}
					});
					/*把拖拽的对象放到当前行中*/
					$(event.target).append(ui.draggable);
					/*将拖拽后的附件类型重新归类为新的附件类型*/
					$(event.target).removeClass("over");
				}
			}
		}); 
    },
    getAttachDataJson: function(showType) {
        if ($.mainId == "" || $.mainId == undefined || $.mainId == "null") {
            return false;
        }
        $.Loading({type:"html",speed:200,loadPicNum:2,msg:"正在加载附件...",autoHide:false});
        var urlSt = "editPageGenController.do?getAttachDataJson&showType="+showType+"&versionNum=" + $.versionNum + "&bussTemplateId=" + $.bussTemplateId + "&mainId=" + $.mainId + "&bussCode=" + $.businessCode;
        $.ajax({
            async: true,
            cache: false,
            type: 'GET',
            url: urlSt, /* 请求的action路径*/
            error: function() { /* 请求失败处理函数*/
            	$.closeLoading_();/*关闭加载窗口*/
            	$.Loading({type:"html",speed:200,loadPicNum:2,msg:"加载附件出现异常...",autoHide:false});
            },
            success: function(data) {
                /*console.log(data);*/
                $.closeLoading_();/*关闭加载窗口*/
                var d =data;/* $.parseJSON(data);*/
                $.each(d, function(index, d1) {
                    try {
                            $.each(d1.main, function(index, d2) {
                            	var fileHtml="";
                            	if(showType=="v_formFileByGroup"){
                            		var valObj=new Object();
                                	valObj.picName=d2.attachmenttitle;
                                	valObj.fileId=d2.id;
                                	var disabled_=$('#goal_tab_attachmen_type_'+d2.field_name).attr("disabled_");
                                	
                                    fileHtml = $.getAttachHtml(d2.infotypeid,valObj,disabled_);
                                    $('#goal_tab_attachmen_type_'+d2.field_name+' #td_file_body_'+d2.infotypeid).append(fileHtml);
                                    if(disabled_=="false"){
                                    	$.initAttchDrapDrop(d2.field_name);
                                    }
                            	}else{
                            		fileHtml += "<div id=\"uploadList_" + d2.id + "\" class=\"upload_append_list\"  data-id=\"" + d2.id + "\" >";
                                    fileHtml += "<div class=\"file_bar\"  >";
                                    fileHtml += "<div style=\"padding:5px;\">";
                                    fileHtml += "<p class=\"file_name\">" + d2.attachmenttitle + "</p>" +
                                    		"<span class=\"file_del\" data-id=\"" + d2.id + "\" title=\"删除\"></span>	";
                                    fileHtml += "</div>";
                                    fileHtml += "</div>";
                                    fileHtml += "<a style=\"height:30px;width:100%;\" href=\"#\" class=\"imgBox\">";
                                    fileHtml += "<div class=\"uploadImg\"  style=\"padding:0px 40px 0px 2px;\">";
                                    fileHtml += d2.attachmenttitle;
                                    fileHtml += "</div>";
                                    fileHtml += "</a>";
                                    fileHtml += "<p id=\"uploadProgress_" + d2.id + "\" class=\"file_progress\" style=\"display: none; width: 100%;\"></p>";
                                    fileHtml += "<p id=\"uploadFailure_" + d2.id + "\" class=\"file_failure\">上传失败，请重试</p>";
                                    fileHtml += "<p id=\"uploadSuccess_" + d2.id + "\" class=\"file_success\" style=\"display: block;\"></p>";
                                    fileHtml += "</div>";
                                    $(".myFileUpload_" + d2.field_name).find("#preview").append(fileHtml);
                                    $.funBindDelEvent(d2.field_name);
                                    $.funBindHoverEvent(d2.field_name);
                            	}
                                var attach_id=$("#"+d2.field_name).val();
        						attach_id+=d2.id+",";
        						$("#"+d2.field_name).val(attach_id);
                            });
                            $.closeLoading_();/*关闭加载窗口*/
                    } catch (e) {
                    	$.closeLoading_();/*关闭加载窗口*/
                    	$.Loading({type:"html",speed:200,loadPicNum:2,msg:"加载附件出现异常...",autoHide:false});
                    }
                });
                
            }
        });
    },
    initViewer: function() {
    	var viewer = new Viewer(document.getElementById('mainPageForm'), {
    		url: 'data-original',
    		build: function() {
    			console.log('build');
    		},

    		built: function() {
    			console.log('built');
    		},

    		show: function() {
    			console.log('show');
    		},

    		shown: function() {
    			console.log('shown');
    		},

    		hide: function() {
    			console.log('hide');
    		},

    		hidden: function() {
    			console.log('hidden');
    		},

    		view: function() {
    			console.log('view');
    		},

    		viewed: function() {
    			console.log('viewed');
    		}
    	});
    },
    getVFormPicDataJson: function() {
        if ($.mainId == "" || $.mainId == undefined || $.mainId == "null") {
            return false;
        }
        $.Loading({type:"html",speed:200,loadPicNum:2,msg:"正在加载文件...",autoHide:false});
        var urlSt = "editPageGenController.do?getPicDataJson&versionNum=" + $.versionNum + "&bussTemplateId=" + $.bussTemplateId + "&mainId=" + $.mainId + "&bussCode=" + $.businessCode;
        $.ajax({
            async: true,
            cache: false,
            type: 'GET',
            url: urlSt, /* 请求的action路径*/
            error: function() { /* 请求失败处理函数*/
            	$.closeLoading_();/*关闭加载窗口*/
            	$.Loading({type:"html",speed:200,loadPicNum:2,msg:"加载图片时出现异常...",autoHide:false});
            },
            success: function(data) {
            	 console.log("getVFormPicDataJson----------------");
                console.log(data);
                $.closeLoading_();/*关闭加载窗口*/
                var d =data;/* $.parseJSON(data);*/
                $.each(d, function(index, d1) {
                    try {
                    	 $.each(d1.main, function(index2, d2) {
                    		 var backFileJson=[];
                    		 backFileJson.push({picName:d2.attachmenttitle,fileName:d2.attachmenttitle,fileId:d2.id,fileUrl:d2.realpath});
                    		 $.callbackFunction(backFileJson,d2.field_name);
                    	 });
                    } catch (e) {
                    	$.closeLoading_();/*关闭加载窗口*/
                    	$.Loading({type:"html",speed:200,loadPicNum:2,msg:"加载图片时出现异常...",autoHide:false});
                    }
                });
            }
        });
    },
    getLinkBussDataJson: function() {
    	
        if ($.mainId == "" || $.mainId == undefined || $.mainId == "null") {
            return false;
        }
        $.Loading({type:"html",speed:200,loadPicNum:2,msg:"正在加载明细数据...",autoHide:false});
        var urlSt = "editPageGenController.do?getLinkBussDataJson&versionNum=" + $.versionNum + "&bussTemplateId=" + $.bussTemplateId + "&mainId=" + $.mainId + "&bussCode=" + $.businessCode;
        $.ajax({
            async: false,
            cache: false,
            type: 'GET',
            url: urlSt, /* 请求的action路径*/
            error: function() { /* 请求失败处理函数*/
            	$.closeLoading_();/*关闭加载窗口*/
            	$.Loading({type:"html",speed:200,loadPicNum:2,msg:"加载明细数据出现异常...",autoHide:false});
            },
            success: function(data) {
                /*console.log(data);*/
                var d = data;/*$.parseJSON(data);*/
                    try {
                        if (d.type == "link") {
                            for (var c = 0; c < d.linkCount; c++) {
                            	$.getTemplateHtml1(d["linkBussCode" + c]);
                            	if(d["link" + c].length>0){
                            		$.each(d["link" + c], function(index, d2) {
                            			eval("addBtn_" + d["fieldName" + c] + "('tbody_" + d["linkBussCode" + c] + "')");
                                        $.each(d2, function(index, d21) {
                                            if ($(".ui-draggable").find("[id='" + d21.id + "']").length > 0) {
                                                $(".ui-draggable").find("[id='" + d21.id + "']").val(d21.value);
                                            }
                                        });
                                    });
                            	}
                            }
                        }
                    } catch (e) {
                    	$.closeLoading_();/*关闭加载窗口*/
                    	$.Loading({type:"html",speed:200,loadPicNum:2,msg:"加载明细数据出现异常...",autoHide:false});
                    }
            }
        });
    },
    getBussDataJson: function() {
    	
    	/**需要获取系统变量值
        if ($.mainId == "" || $.mainId == undefined || $.mainId == "null") {
            return false;
        }
        */
    	$.Loading({type:"html",speed:200,loadPicNum:2,msg:"正在加载数据...",autoHide:false});
        var urlSt = "editPageGenController.do?getBussDataJson&taskId="+$.taskId+"&versionNum=" + $.versionNum + "&bussTemplateId=" + $.bussTemplateId + "&mainId=" + $.mainId + "&bussCode=" + $.businessCode;
        $.ajax({
            async: true,
            cache: false,
            type: 'GET',
            url: urlSt, /* 请求的action路径*/
            error: function() { /* 请求失败处理函数*/
            	$.closeLoading_();/*关闭加载窗口*/
            	$.Loading({type:"html",speed:200,loadPicNum:2,msg:"数据加载出现异常...",autoHide:false});
            },
            success: function(data) {
                /*console.log(data);*/
                $.closeLoading_();/*关闭加载窗口*/
                var d = data;/*$.parseJSON(data);*/
                $.each(d, function(index, d1) {
                    try {
                        if (d1.type == "main") {
                            $.each(d1.main, function(index, d2) {
                            	/*赋值普通文本*/
                            	var myInput=$(".ui-draggable").find("[id='" + d2.id + "']");
                            	var myValue=d2.value;
                                if ($(myInput).length > 0) {
/*                               	if($(myInput).attr("tt")=="date")myValue=$.formatDate("yyyy-MM-dd",d2.value);
                                	if($(myInput).attr("tt")=="datetime")myValue=$.formatDate("hh:mm:ss",d2.value);
                                	if($(myInput).attr("tt")=="year")myValue=$.formatDate("yyyy",d2.value);
                                	if($(myInput).attr("tt")=="yymm")myValue=$.formatDate("yyyy-MM",d2.value);
*/
                                	$(myInput).val(myValue);
                                }
                                
                                /*赋值radio，checkbox*/
                                var myValues=myValue.split(",");
                                if(myValues.length>0){
                                	for(var t=0;t<myValues.length;t++){
                                		if ($(".ui-draggable").find("input[name='"+d2.id+"'][value='"+myValues[t]+"']").length > 0) {
                                        	$(".ui-draggable").find("input[name='"+d2.id+"'][value='"+myValues[t]+"']").attr("checked", true);
                                        }
                                	}
                                }
                                if($(myInput).find("option[value='"+myValue+"']").length>0){
                                	$(myInput).find("option[value='"+myValue+"']").attr("selected","selected");
                                	$(myInput).next().find("input").val($(myInput).find("option[value='"+myValue+"']").text());
                                	$("dd[lay-value='"+myValue+"']").attr("class","layui-this");
                                }
                                /*if("BD1531128557965@A0302"==d2.id){alert($(myInput).val());}*/
                            });
                        }
                    } catch (e) {}
                });
                layui.use(['form','laydate'], function(){
        			$.designform = layui.form;
        			var laydate = layui.laydate;
        			$("input[class^='Wdate']").each(function(i){
        				var $this = $(this);
        				laydate.render({
        				    elem:".Wdate_"+$this.attr("did"), /*指定元素*/
        				    type: $this.attr("tt")=="yymm"?"month":$this.attr("tt")
        				 });
        			});
        		});
            }
        });
    }, /* 绑定删除按钮事件*/
    formatDate:function(format,value) {
    	/*
    	 * eg:format="yyyy-MM-dd hh:mm:ss";
    	 */
    	if (!format) {
    		format = "yyyy-MM-dd hh:mm:ss";
    	}
    	if(value==''||value==null){
    		return '';
    	}
    	var strdata=value.replace(/-/g,"/");
    	var index=strdata.indexOf(".");
    	if(index>0)
    	{
    		strdata=strdata.substr(0,index);
    	}
    	var date=(value=="this")?new Date():new Date(Date.parse(strdata));
    	var o = {
    		"M+" : date.getMonth() + 1, /* month*/
    		"d+" : date.getDate(), /* day*/
    		"h+" : date.getHours(), /* hour*/
    		"m+" : date.getMinutes(), /* minute*/
    		"s+" : date.getSeconds(), /* second*/
    		"q+" : Math.floor((date.getMonth() + 3) / 3), /* quarter*/
    		"S" : date.getMilliseconds()
    		/* millisecond*/
    	};
    	
    	if (/(y+)/.test(format)) {
    		if(value=="this"){
    			format=format.replace(RegExp["$1"], (date.getFullYear()+"").substr(4 - RegExp["$1"].length)); 
    		}else{
    			format = format.replace(RegExp["$1"], strdata.substr(4-RegExp["$1"].length,RegExp["$1"].length));
    		}
    		
    	}
    	
    	for (var k in o) {
    		if (new RegExp("(" + k + ")").test(format)) {
    			format = format.replace(RegExp["$1"], RegExp["$1"].length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
    		}
    	}
    	return format;
    },
    funBindDelEvent: function(field_name) {
        if ($(".myFileUpload_" + field_name).find(".file_del").length > 0) {
            /* 删除方法*/
            $(".myFileUpload_" + field_name).find(".file_del").click(function() {
                var ts=$(this);
                var dindex=$(this).attr("data-index");
                if(ts.attr("data-id")==undefined){
                	ts=$(this).closest("#uploadList_"+$(this).attr("data-index"));
                }else{
                	dindex=$(this).attr("data-id");
                }
				var id=ts.attr("data-id");
				myConfirmDialog("您确定要删除吗？", function() {
					$.ajax({
						async : false,
						cache : false,
						type : 'POST',
						url : "cgformAttchController.do?delFile&id=" + id,/* 请求的action路径*/
						error : function() {/* 请求失败处理函数*/
						},
						success : function(data) {
							layer.msg('删除成功！', {icon : 1});
							 var attach_id = $("#" + field_name).val();
				                attach_id = attach_id.replace(id + ",", "");
			                 $("#" + field_name).val(attach_id);
							 $("#uploadList_"+dindex).remove();
							return true;
						}
					});
				}, function() {
					return true;
				}, "");
                
                return false;
            });
        }
        if ($(".myFileUpload_" + field_name).find(".upload_append_list").length > 0) {
            /* 编辑方法*/
            $(".myFileUpload_" + field_name).find(".upload_append_list").click(function() {
            	var $ts=$(this);
				var id=$ts.attr("data-id");
            	window.open("cgformAttchController.do?downloadFile&fileid="+id);
                return false;
            });
        }
    },/* 绑定显示操作栏事件*/
    funBindHoverEvent: function(field_name) {
    	var isdisabled_ =$("#"+field_name).attr("isdisabled_");
    	if(isdisabled_!="true"){
    		 $(".myFileUpload_" + field_name).find(".upload_append_list").hover(function(e) {
    	            $(this).find(".file_bar").addClass("file_hover");
    	        }, function(e) {
    	            $(this).find(".file_bar").removeClass("file_hover");
    	        });
    	}
    },
    getDesignWidgets_hide: function(no_) {
        var widgets_ = new Array();
        $.each($.FieldsMap, function(key, value) {
            if (value.isFormHide == "Y" || value.isFormHide == "1") { /* 过滤掉表单不显示的控件*/
                var wi_ = new Object();
                wi_.x = value.x;
                wi_.y = value.y;
                wi_.width = value.w;
                wi_.height = value.h;
                wi_.locked = no_;
                wi_.design_id = value.design_id;
                if (value.design_type != undefined) {
                    wi_.design_type = value.design_type;
                } else {
                    wi_.design_type = value.showType;
                }
                wi_.auto_position = false;
                widgets_[widgets_.length] = wi_;
                /* console.log(JSON.stringify(wi_));*/
            }
        });
        return GridStackUI.Utils.mySort(widgets_);
    },
    getDesignWidgets_: function(no_) {
        var widgets_ = new Array();
        $.each($.FieldsMap, function(key, value) {
            if ((value.isShow == "Y" || value.isShow == "1") && 
            		(value.isFormHide != "Y" && value.isFormHide != "1")) { /* 过滤掉表单不显示的控件*/
                var wi_ = new Object();
                wi_.x = value.x;
                wi_.width = value.w;
                wi_.height = value.h;
                wi_.is_show = value.isShow;
                wi_.locked = no_;
                wi_.design_id = value.design_id;
                wi_.y =value.y;
                if (value.design_type != undefined) {
                    wi_.design_type = value.design_type;
                } else {
                    wi_.design_type = value.showType;
                }
                
                wi_.auto_position = false;
            	widgets_[widgets_.length] = wi_;
                /* console.log(JSON.stringify(wi_));*/
            }
        });
        return GridStackUI.Utils.mySort(widgets_);
    },
    getDesignHeaderHtml: function(designId, type) {
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n<div ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        if (type == "v_formGroupingTitle") {
            html_ += " class='profile-user-info dropdiv para-title level-2' style='border:0px;' label-module='para-title' " + "design-title-titleName='" + designO["content"] + "'  design-title-fontSize=''  design-title-fontColor='' >";
            html_ += "<div class='title-text'><text_content >" + designO["content"] + "</text_content></div>";
            html_ += "</div>\n";
        }
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    getDesignMswzHtml: function(designId, type) {
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ += "<div  ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += " class=' profile-user-info dropdiv'  style='display: block;border:0px;'>";
        html_ += "<div class='paragraph alert alert-success' ><text_content >" + designO["content"] + "</text_content></div>";
        html_ += "</div>\n";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    getDesignButtonHtml: function(designId, type) {
        var lhref = location.href,urlSt = "";
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ += "<div  ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += "  class=\"profile-user-info dropdiv center\" style=\"border:0px;\">";
        html_ += "<div type=\"button\" class=\"layui-btn layui-btn-normal\" id='" + $.businessCode+"@"+designO["fieldName"] + "' >";
        html_ += "<text_content >" + designO["content"] + "</text_content>";
		html_ += "</div>";
        html_ += "</div>\n";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    getDesignSaveButtonHtml: function(designId, type) {
        var lhref = location.href,urlSt = "";
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ += "<div  ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += "  class=\"profile-user-info dropdiv center\" style=\"border:0px;\">";
        html_ += "<div type=\"button\" onclick='form_default_save()' class=\"layui-btn layui-btn-normal\" id='" + $.businessCode+"@"+designO["fieldName"] + "' >";
        html_ += "<text_content >" + (designO["content"]==""?"保存":designO["content"]) + "</text_content>";
		html_ += "</div>";
        html_ += "</div>\n";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    getDesignSubmitButtonHtml: function(designId, type) {
        var lhref = location.href,urlSt = "";
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ += "<div  ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += "  class=\"profile-user-info dropdiv center\" style=\"border:0px;\">";
        html_ += "<div type=\"button\" onclick='form_default_submit()' class=\"layui-btn layui-btn-normal\" id='" + $.businessCode+"@"+designO["fieldName"] + "' >";
        html_ += "<text_content >" +  (designO["content"]==""?"发送":designO["content"])  + "</text_content>";
		html_ += "</div>";
        html_ += "</div>\n";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    getDesignCloseButtonHtml: function(designId, type) {
        var lhref = location.href,urlSt = "";
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ += "<div  ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += "  class=\"profile-user-info dropdiv center\" style=\"border:0px;\">";
        html_ += "<div type=\"button\" onclick='form_default_close()' class=\"layui-btn layui-btn-normal\" id='" + $.businessCode+"@"+designO["fieldName"] + "' >";
        html_ += "<text_content >" +  (designO["content"]==""?"关闭":designO["content"])  + "</text_content>";
		html_ += "</div>";
        html_ += "</div>\n";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    getDesignGroupButtonHtml: function(designId, type) {
        var lhref = location.href,urlSt ="";
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        
        html_ = "<div ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += " class=\" profile-user-info dropdiv \"   style=\"padding-top:1px;text-align: left;border:0px;overflow-y: hidden;\">";
        html_ += "<div class='para-title level-2' label-module='para-title'  >";
        html_ += "</div>\n";
        if ($.isEdit) {
        	 html_ += "<div class=\"form-layout-toolbar\"><span class=\"edit-btn\" onclick='$.addButton(this)'>维护按钮</span>";
             html_ += "</div>";
        }
        html_ +=$.getTemplateButton(designO["fieldName"]);
        if ($.isEdit) {
	        html_ += "<div class=\"form-layout-mask\">";
	        html_ += "</div>";
        }
        html_ += "</div>\n";
        html_ += "<div style='margin-top: 3px;border-bottom: 2px solid #48a1e4;'>";
        html_ += "</div>";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    getDesignFormTitleHtml: function(designId, type) {
        var lhref = location.href,urlSt = "";
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ += "<div  ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
            html_ += "  class=\"profile-user-info dropdiv center\" style=\"border:0px;\">";
            html_ += "<div class=\"line-title\" style=\"height: 80px;clear: both;\">";
            html_ += "<p class=\"title\" style=\"width: 450px;height: 80px;margin: 0 auto;text-align: center;";
            html_ += "line-height:40px;";
/*            html_ += "background-color: #fff;";*/
            html_ += "position: relative;";
            html_ += "\"><text_content  style=\"font-size: 23px;\">" + designO["content"] + "</text_content ></p>";
            html_ += "</div>";
            html_ += "</div>\n";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    getDesignVFormPicHtml: function(designId, type) {
        var lhref = location.href,urlSt = "";
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ += "<div  ";
        var disabled_=designO["isEdit"]=="N"?"true":"false";
        
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
            html_ += "  class=\"dropdiv center\" style=\"\">";
            html_ += " <input type='hidden' id='" + designO["fieldName"] + "' name='" + designO["fieldName"] + "' value='' >";
            html_ += "					<div class=\"profile-user-info\" style=\"border:0px;text-align: center;\">";
            html_ += "					<div id=\"imgs2_"+designO["fieldName"]+"\" style=\"\">";
            html_ += "						<span class=\"profile-picture\" >";
            html_ += "							<div id=\"dimg_"+designO["fieldName"]+"\" class=\"p-img\" style=\"position: relative;padding:auto\">";
            html_ += "								<img style=\"width:200px;height:200px\" data-img=\"1\" " +
            		"src=\"" + urlSt + "designPlug-in/jd/image/win_11.gif\" " +
            		"onerror=\"javascript: this.src = '" + urlSt + "designPlug-in/jd/image/win_11.gif'\" title=\"\"> " +
            				"<i style=\"cursor:pointer;position: absolute;top: 0px;right: 0px;\" class='design-icon-task-close' onclick=\"$.delPic(this,'"+designO["fieldName"]+"')\" title=\"删除\" class=\"times\" id=\"\"></i>";
            html_ += "							</div>";
            html_ += "							<div class=\"p-scroll scrolled\" isprevornext=\"ximg_"+designO["fieldName"]+"|44\">";
            html_ += "								<span onclick=\"psPrev(44,'ximg_"+designO["fieldName"]+"',this)\" style=\"z-index: 1;display: none;\" class=\"ps-prev disabled\">";
            html_ += "									&lt; </span> <span onclick=\"psNext(44,'ximg_"+designO["fieldName"]+"',this)\" style=\"z-index: 1;display: none;\" class=\"ps-next\"> &gt;";
            html_ += "								</span>";
            html_ += "								<div class=\"ps-wrap\">";
            html_ += "									<div id=\"ximg_"+designO["fieldName"]+"\" class=\"ps-main\"> " +
            				"</div>";
           
	            html_ += "									<div style=\"float:right\">";
	            if (disabled_=="false") {
	            html_ += "<span class=\"ps-item\" style=\"width: 35px;height: 35px;cursor: pointer;background: url(designPlug-in/ace/assets/avatars/13485900.png);";
	            html_ += "background-repeat: no-repeat;";
            	html_ += "background-size: 100% 100%;\"  onclick=\"$.uploadFile('"+designO["fieldName"]+"')\" > ";
	            html_ += " </span>";
	            }
            html_ += "</div></div>";
            html_ += "							</div>";
            html_ += "						</span>";
            html_ += "					</div>";
            html_ += "</div>\n";
            html_ += "</div>\n";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    uploadFile:function(fieldName){
    	uploadFileIndex_=layer.open({
        title : "附件上传",
        area: ['40%', '80%'],
        type : 2,
        content : 'cgformAttchController.do?uploadFile&designId='+fieldName
        });
    },
    callbackFunction:function(backFileJson,fieldName){
    	if(backFileJson.length>0){
		var picIds=$('#'+fieldName).val();
			$(backFileJson).each(function(i,val) {
				var culIndexHtml='';picIds+=val.fileId+',';
				culIndexHtml+=' <span  class="ps-item" ><a onmouseout="$.onmouseoutPic(this,\''+fieldName+'\')" onmouseover="$.onmouseoverPic(this,\''+fieldName+'\')"';
		        culIndexHtml+=' title="'+val.fileName+'" infotypename="'+val.picName+'" id="'+val.fileId+'" href="javascript:;"><img';
		        culIndexHtml+=' data-original="cgformAttchController.do?showImg&fileId='+val.fileId +'"  class="loading-style2"';
		        culIndexHtml+=' src="cgformAttchController.do?showImg&fileId='+val.fileId +'"> ';
		        culIndexHtml+=' </a></span> ';
		        $('#ximg_'+fieldName).append(culIndexHtml);
	        });
			$('#'+fieldName).val(picIds);
	    	$('#dimg_'+fieldName).find('img').attr('src','cgformAttchController.do?showImg&fileId='+backFileJson[backFileJson.length-1].fileId);
			$('#dimg_'+fieldName).find('span').text(backFileJson[backFileJson.length-1].picName);
			$('#dimg_'+fieldName).find('.times').attr('id', backFileJson[backFileJson.length-1].fileId);
			$('#imgs2_'+fieldName).show();
			$('#imgs1_'+fieldName).hide();
			$.initViewer();//初始化图片查看插件data-original，可以设置为原图地址
		}
		try{
		$.initializePrevOrNext(fieldName);
		}catch(e){
		}
		try{
		layer.close(uploadFileIndex_);
	    }catch(e){
		}
    },
    initializePrevOrNext:function(fieldName) {
    	$('#imgs2_'+fieldName).find('div[isPrevOrNext]').each(function(index){
    		var prevOrNext=$(this).attr('isPrevOrNext');
    		var prevOrNexts=prevOrNext.split('|');
    		var height_1_ =$('#'+prevOrNexts[0]).height();
    		if(height_1_>prevOrNexts[1]){
	    		$(this).find('.ps-prev').show();
	    		$(this).find('.ps-next').show();
    		}else{
	    		$(this).find('.ps-prev').hide();
	    		$(this).find('.ps-next').hide();
    		}
    	});
    },
    onmouseoutPic:function(thisa, fieldName) {
    	$(thisa).removeClass('curr');
    },
    onmouseoverPic:function(thisa, fieldName) {
    	var swlsrc = $(thisa).find('img').attr('src');
    	var id = $(thisa).attr('id');
    	var infotypename = $(thisa).attr('infotypename');
    	$('#dimg_'+fieldName).find('.times').attr('id', id);
    	$('#dimg_'+fieldName).find('img').attr('src', swlsrc);
    	$('#dimg_'+fieldName).find('span').text(infotypename);
    	$(thisa).addClass('curr');
    },
    getDesignOfficeHtml: function(designId, type) {
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ += "<div  ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += "  class=\"profile-user-info dropdiv center\" style=\"width: 100%;height: 100%;border: 0px solid #CCCCCC;\">";
        html_ += "<div style='margin: 0 1px;' class='profile-user-info profile-user-info-striped'>";
        html_ += "\n";
        html_ += "<div class='profile-info-row' style='min-height: 35px;'>";
        html_ += "\n";
        html_ += "<div class='profile-info-name' >";
        html_ += "<font color='red'><text_isNotnull></text_isNotnull></font>";
        html_ += "<text_content >" + designO["content"] + "</text_content>";
        html_ += "</div>";
        html_ += "\n";
        html_ += "<div class='profile-info-value' style='white-space: nowrap;";
        html_ += "word-wrap: normal;padding-left: 0px;'>";
        html_ += "<div class='layui-btn layui-btn-primary layui-btn-sm'  onclick=\"openOfficeWindow_"+designO["fieldName"]+"('"+designO["fieldName"]+"')\">编辑正文</div>";
        html_ += "<span  id='office_div_"+designO["fieldName"]+"' style='color:red;margin-left:5px;' ></span>";
        html_ += "</div>";
        html_ += "</div>\n";
        html_ += "</div>\n";
        html_ += "</div>\n";
        html_ += "<script  type=\"text/javascript\"  >";
        html_ += " function openOfficeWindow_"+designO["fieldName"]+"(fieldName) {";
        html_ += " var id =$('#"+$.businessCode+"\\\\@id').val();";
        html_ += "if(id==''||id==undefined||id==null){layer.msg('请先保存！', {icon: 5});return false;}";
		html_ += "window.open('tBCommProjecreplyController.do?openOffice&projectId="+$.mainId+"&fieldName='+fieldName);";
		html_ += "}";
        html_ += "</script>";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        return html_;
    },
    setOfficeData: function(fieldName) {
    	$("#office_div_"+fieldName).html("最后修改时间："+$.formatDate("yyyy-MM-dd hh:mm:ss","this"));
    },
    getDesignMyFileHtml: function(designId, type) {
        var lhref = location.href,urlSt = "";
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var disabled_=designO["isEdit"]=="N"?"true":"false";
        var html_ = "\n";
        html_ += "<div  ";
        if ($.isEdit) {
	        $.each($.Fields, function(index, val) {
	            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
	        });
        }
        html_ += "  class=\"profile-user-info dropdiv center\" style=\"border: 0px solid #CCCCCC;\">";
        html_ += "<div class='para-title level-2' label-module='para-title'  >";
        html_ += "<div class='title-text'><text_content >"+((designO["content"]=="")?"附件信息":designO["content"])+"</text_content></div>";
        html_ += "</div>\n";
        if ($.isEdit) {
        html_ += "<div style='color:red;text-align: left;' >需在运行环境中才能上传,此类型控件只能允许一个</div>";
        }
        html_ += " <input type='hidden' isdisabled_='"+disabled_+"' id='" + designO["fieldName"] + "' name='" + designO["fieldName"] + "' value='' >";
        html_ += "	<div id=\"myFileUpload_" + designO["fieldName"] + "\" fieldname='"+designO["fieldName"]+"' disabled_='"+disabled_+"' class=\"myFileUpload_" +  designO["fieldName"] + "\"></div>";
        html_ += "</div>\n";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        /**
        if (!$.isEdit) {
        	html_ += "<script  type=\"text/javascript\"  >";
            html_ += "var initAttachObj_"+ designO["fieldName"]+" = window.setInterval('initAttachDataObj_"+ designO["fieldName"]+"()',500);";
            html_ += "function initAttachDataObj_"+designO["fieldName"]+"() {";
    		html_ += "if($('#myFileUpload_"+ designO["fieldName"]+"').length>0){";
    		html_ += "initZyUpload('" +  designO["fieldName"] + "','"+$.mainId+"','"+disabled_+"');window.clearInterval(initAttachObj_"+ designO["fieldName"]+");";
    		html_ += "}";
    		html_ += "}";
            html_ += "</script>";
        }
        */
        
        return html_;
    },
    getDesignMyGroupFileHtml: function(designId, type) {
        var lhref = location.href,urlSt = "";
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var disabled_=designO["isEdit"]=="N"?"true":"false";
        var html_ = "\n";
        html_ += "<div  ";
        if ($.isEdit) {
	        $.each($.Fields, function(index, val) {
	            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
	        });
        }
        html_ += "  class=\"profile-user-info dropdiv center\" style=\"border: 0px solid #CCCCCC;\">";
        html_ += "<div class='para-title level-2' label-module='para-title'  >";
        html_ += "<div class='title-text'><text_content >"+((designO["content"]=="")?"附件信息":designO["content"])+"</text_content></div>";
        html_ += "</div>\n";
        html_ += "<table width=100% cellpadding='0' " +
        		"cellspacing='1' disabled_='"+disabled_+"' id='goal_tab_attachmen_type_" + designO["fieldName"] + "' " +
        		" style='border-spacing: 1px;border-collapse: inherit;' border='0'  class='formtable' >";
        var dataObj = $.getDictDataHtml(designId,designO["selectId"],designO["fieldHref"]);
        if(dataObj != null && dataObj!=""){
        	html_ += "<tr style='height:35px;' style='border:thin solid #0099ff'>";
	        html_ += "<td width='5%'  nowrap align='center'  >序号</td>";
	        html_ += "<td  width='20%' align='center'  >文件类型</td>";
	        html_ += "<td  align='center'  width='50%' >文件</td>";
	        /*html_ += "<td align='center'  width='15%' >上传时间</td>";*/
	        if(disabled_=="false"){
	        	html_ += "<td  width='10%'  style='text-align: center;'>操作</td>";
	        }
	        
	        
	        html_ += "</tr>";
        	for(var k=0;k<dataObj.count;k++ ){
        		var json = dataObj.resultList[k];
        			html_ += "<tr style='height:35px;'  style='border:thin solid #0099ff'>";
        	        html_ += "<td   nowrap align='center' class='value' >"+(k+1)+"</td>";
        	        html_ += "<td   valign='top'  class='value' typecode='"+json.typecode+"'  id='td_file_label_"+json.typecode+"'>&nbsp;";
        	        html_ += json.typename+"</td>";
        	        html_ += "<td  id='td_file_body_"+json.typecode+"' typecode='"+json.typecode+"'  class='value attchDropDiv' colspan='1' >";
        	        html_ += "</td>";
        	       /* html_ += "<td align='center' class='value' id='td_file_time_"+json.typecode+"'  >--</td>";*/
        	        if(disabled_=="false"){
        	        html_ += "<td style='text-align: center;' class='value'><span class='layui-btn layui-btn-xs layui-btn-normal' onclick=\"$.uploadBigFile_new('"+json.typecode+"','" + designO["fieldName"] + "');\" href='#' >" +
        	        		"<i class='layui-icon'></i>添加</span>";
        	        html_ += "</td>";
        	        }
        	        html_ += "</tr>";
        	}
    	}
        html_ += "</table>";
        html_ += " <input type='hidden' isdisabled_='"+disabled_+"' id='" + designO["fieldName"] + "' name='" + designO["fieldName"] + "' value='' >";
        if ($.isEdit) {
            html_ += "<div class='canDragEl' ></div>";
        }
        
        return html_;
    },
    uploadBigFile_new:function(typecode,fieldName){
    	uploadBigFileIndex_=layer.open({
        title : "附件上传",
        area: ['40%', '80%'],
        type : 2,
        content : 'cgformAttchController.do?uploadBigFile_new&typecode='+typecode+'&designId='+fieldName
        });
    },
    callbackBigFileFunction:function(backFileJson,fieldName,typecode){
    	if(backFileJson.length>0){
		var picIds=$('#'+fieldName).val();
			$(backFileJson).each(function(i,val) {
				picIds+=val.fileId+',';
		        var HtmlStr =$.getAttachHtml(typecode,val,"false");
				/*不用显示上传时间，如果多个文件时，时间如何处理*/
				/*$('#goal_tab_attachmen_type_'+fieldName+' #td_file_time_'+typecode).html(val.uploadTime);*/
		        $('#goal_tab_attachmen_type_'+fieldName+' #td_file_body_'+typecode).append(HtmlStr);
	        });
			$.initAttchDrapDrop(fieldName);
			$('#'+fieldName).val(picIds);
		}
/*		try{
		$.initializePrevOrNext(fieldName);
		}catch(e){
		}*/
		try{
		layer.close(uploadBigFileIndex_);
	    }catch(e){
		}
    },
    getAttachHtml:function(typecode,val,disabled_) {
    	 var HtmlStr ="<div  class='crumbs-nav-item' style='cursor: move;float:left;margin:1px'>";
			HtmlStr=HtmlStr+"<div style='width: 90px;float:left;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;border: 1px solid #98BDFF;'>";
			HtmlStr=HtmlStr+"<input id='attchtype_id' data-original='  name='attchtype_id' type='hidden' value='"+val.fileId+"'>";
			HtmlStr=HtmlStr+"<a target='_blank' href='cgformAttchController.do?downloadFile&fileid="+val.fileId+"' title='"+val.picName+"'    class='myhref'>";
			HtmlStr=HtmlStr+"<font color='#000099'><d1 id='"+val.fileId+"'>"+val.picName+"</d1></font></a>&nbsp;";
			HtmlStr=HtmlStr+"</div>";
			if(disabled_=="false"){
				HtmlStr=HtmlStr+"<div class=\"selector-set\" style='width: 40px;float:left;border: 1px solid #98BDFF;border-left: 0px solid #98BDFF;'>";
				HtmlStr=HtmlStr+"<a href='##' style='color:red;font-size: 14px;' title='删除附件' onclick=\"$.delFile('"+val.fileId+"',this)\" >×</a>";
				HtmlStr=HtmlStr+"</div>";
			}
			HtmlStr=HtmlStr+"</div>";
			return HtmlStr;
    },
    initAttach:function() {
    	$("[id^='myFileUpload']").each(function(i,val) {
    		if($('#'+$(val).attr("fieldname")).length>0){
        		initZyUpload($(val).attr("fieldname"),$.mainId,$(val).attr("disabled_"));
        	}
    	});
    },
    getDesignFieldsHtml: function(designId, type) {
        /* console.log(JSON.stringify($.FieldsMap));
    	console.log(designId+"----type----"+type);*/
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ += "<div  ";
        if ($.isEdit) {
	        $.each($.Fields, function(index, val) {
	            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
	        });
        }
        var isNotnull = designO && designO["isNotnull"] == "Y" ? "*" : "";
        html_ += " class=' col-xs-12 col-md-12 dropdiv' style='margin-bottom: 1px;padding-right: 0px;padding-left: 0px;'>";
        html_ += "\n";
        html_ += "<div style='margin: 0 1px;' class='profile-user-info profile-user-info-striped'>";
        html_ += "\n";
        html_ += "<div class='profile-info-row' style='min-height: 35px;'>";
        html_ += "\n";
        html_ += "<div class='profile-info-name' >";
        html_ += "<font color='red'><text_isNotnull>" + isNotnull + "</text_isNotnull></font>";
        html_ += "<text_content >" + designO["content"] + "</text_content>";
        html_ += "</div>";
        html_ += "\n";
        html_ += "<div class='profile-info-value layui-input-block' style='white-space: nowrap;";
        html_ += "word-wrap: normal;padding-left: 0px;'>";
        var disabled_=designO["isEdit"]=="N"?"disabled='true'":"";
        var id=$.businessCode+"@"+designO["fieldName"];
        var datatype=(designO["fieldValidType"]=="null"||designO["fieldValidType"]=="")?"":"datatype='"+designO["fieldValidType"]+"'";
        if ($.isEdit) {
        	html_ += "<div class='canDragEl' ></div>";
        	}
        if (type == "input" || type == "text") {
            html_ += "<input "+disabled_+" type='text' id='" + id + "' name='" + id;
            html_ += "' value='' isProcessVariables='" + designO["isProcessVariables"] + "' ";
            html_ += " fieldalert='" + designO["fieldAlert"] + "' "+datatype+" nullmsg='请填写信息！' style=''>";
        }
        if (type == "textarea") {
            html_ += "<textarea "+disabled_+"    "+datatype+"  nullmsg='请填写信息！' isProcessVariables='" + designO["isProcessVariables"] + "' style=\"height:61px\" name='" + id+"' ";
            html_ += " id='" + id + "' ></textarea>";
        }
        if (type == "checkbox") {
        	html_ += "<div style='overflow-x: auto;width: auto;padding: 0px 20px;'>";
        	var dataObj = $.getDictDataHtml(designId,designO["selectId"],designO["fieldHref"]);
        	if(dataObj != null && dataObj!=""){
        		/*console.log("---------------------return dataObj--"+dataObj.count);*/
        		var temhtml = "";
            	for(var k=0;k<dataObj.count;k++ ){
            		var json = dataObj.resultList[k];
        			temhtml+="<input  "+disabled_+" lay-skin='primary'    "+datatype+"  nullmsg='请选择！' type='checkbox' isProcessVariables='" + designO["isProcessVariables"] + "'  title='"+json.typename+"' id='select_type_"+designO["fieldName"]+"_"+json.typecode+"' name='" + id + "' value = '"+json.typecode+"'/> ";
            	}
            	html_ += temhtml;
            	/*console.log("---------------------js-checkbox--"+temhtml);*/
        	}
        	html_ += "</div>";
        }
        if (type == "select" || type == "list") {
            var dataObj = $.getDictDataHtml(designId,designO["selectId"],designO["fieldHref"]);
            html_ += "<select "+disabled_+"     "+datatype+"  nullmsg='请选择！' style=\"height: 30px;width:100%;\" isProcessVariables='" + designO["isProcessVariables"] + "' nullmsg='"+designO["fieldAlert"]+"' id=\"" + id;
            html_ += "\" name=\"" + id + "\">   ";
            html_ += "<option value=\"\" >请选择</option>   ";
        	if(dataObj != null && dataObj!=""){
        		var temhtml = "";
            	for(var k=0;k<dataObj.count;k++ ){
            		var json = dataObj.resultList[k];
            		temhtml+=" <option value=\""+json.typecode+"\" >"+json.typename+"</option>  ";
            	}
            	html_ += temhtml;
            	/*console.log("---------------------js-checkbox--"+temhtml);*/
        	}
            html_ += "</select> ";
        }
        if (type == "radio") {
            html_ += "<div style='overflow-x: auto;width: auto;padding: 0px 20px;'>";
        	var dataObj = $.getDictDataHtml(designId,designO["selectId"],designO["fieldHref"]);
        	if(dataObj != null && dataObj!=""){
        		/*console.log("---------------------return dataObj--"+dataObj.count);*/
        		var temhtml = "";
            	for(var k=0;k<dataObj.count;k++ ){
            		var json = dataObj.resultList[k];
            			temhtml+="<input  "+disabled_+"   "+datatype+"  nullmsg='请选择！' type='radio' isProcessVariables='" + designO["isProcessVariables"] + "' id='select_type_"+designO["fieldName"]+"_"+json.typecode+"' name='" + id + "' value = '"+json.typecode+"'  title='"+json.typename+"'/>";
            	}
            	html_ += temhtml;
            	/*console.log("---------------------js-checkbox--"+temhtml);*/
        	}
        	html_ += "</div>";
        }
        if (type == "popup") {
            html_ += "<input  "+disabled_+"   isProcessVariables='" + designO["isProcessVariables"] + "' id=\"" + id + "\" ";
            html_ += "name=\"" + id;
            html_ += "\" type=\"hidden\"  class=\"inputxt\"  value=\"\">";
            html_ += "<input  "+disabled_+"   "+datatype+"  nullmsg='请选择！' isProcessVariables='" + designO["isProcessVariables"] + "' id=\"showName_"+$.businessCode+"_"+designO["fieldName"]+ "\" name=\"showName_"+$.businessCode+"_"+designO["fieldName"];
            html_ += "\" type=\"text\" style=\"width:98%;\" ";
            html_ += "readonly=\"readonly\" class=\"inputxt\"  fieldAlert=\"" + designO["fieldAlert"] + "\"   placeholder=\"请选择\" value=\"\">";
           /*onclick=\"$('#showName_" + $.businessCode+"_"+designO["fieldName"] + "').next().click();\"*/
            html_ += "<div class='"+(disabled_!=""?"grid-stack-item-shortcut-hide'":"grid-stack-item-shortcut")+"'  >";
            html_ += "<i class=\"iconfont\" style=\"cursor: pointer;\" title=\"选择\" onclick=\"choose_"+designO["id"]+"('"+designO["fieldHref"] +"','"+designO["windowWidth"]+"','"+designO["windowHeight"]+"','"+designO["inputId"]+"','"+designO["selectId"]+"','"+designO["wherePara"]+"');\">&#xe613;选择</i>&nbsp;&nbsp;";
            html_ += "<i class=\"iconfont\" style=\"cursor: pointer;\" title=\"清除\" onclick=\"clearAll_"+designO["id"]+"();\">&#xe636;清除</i>";
            html_ += "</div>";
            html_ += "\n";
            html_ += "<script  type=\"text/javascript\"  >";
            html_ += " function clearAll_"+designO["id"] + "() {";
            html_ += " try{clearAll_"+$.businessCode+"_"+designO["fieldName"]+"();}catch(e){";
            html_ += "$('#" + $.businessCode+"\\@"+designO["fieldName"] + "').val('');";
            html_ += "$('#showName_" + $.businessCode+"_"+designO["fieldName"] + "').val('');";
            html_ += "} ";
            html_ += "}";
            
            html_ += "function choose_"+designO["id"]+"(fieldHref,windowWidth_,windowHeight_,inputId,selectId,wherePara) {";
            html_ += "if(fieldHref==\"\"||fieldHref==null){";
            html_ += "layer.msg('请先配置数据源！', {icon: 5});";
            html_ += "return false;";
            html_ += " }";
            html_ += "var windowWidth = windowWidth_!=null&&windowWidth_!=\"\"&&windowWidth_!=\"null\"?windowWidth_:document.body.offsetWidth*(parseFloat(\"100\")/100);";
            html_ += "var windowHeight = windowHeight_!=null&&windowHeight_!=\"\"&&windowHeight_!=\"null\"?windowHeight_:document.body.offsetHeight*(parseFloat(\"100\")/100)-100;";
            html_ += "if(windowWidth.toString().indexOf(\"%\")!=-1){";
            html_ += "windowWidth = document.body.offsetWidth*(parseFloat(windowWidth)/100);";
            html_ += "}";
            html_ += "if(windowHeight.toString().indexOf(\"%\")!=-1){";
            html_ += "windowHeight =document.body.offsetHeight*(parseFloat(windowHeight)/100)-100;";
            html_ += "}";
            html_ += "windowHeight=parseFloat(windowHeight);";
            html_ += "windowHeight=windowHeight;";
            html_ += "layer.open({";
            html_ += "type: 2,";
            html_ += "title: '请选择',";
            html_ += "maxmin: true,";
            html_ += "shadeClose: true,";
            html_ += "area: [windowWidth+'px', windowHeight+'px'],";
            html_ += "content: 'editPageGenController.do?goSelectPage&wherePara='+wherePara+'&selectId='+selectId+'&inputId='+inputId+'&sCode='+fieldHref,";
            html_ += "btn: ['确定', '关闭'],";
            html_ += " yes: function(index, layero) {";
           /* html_ += " try{clickcallback_" + $.businessCode+"_"+designO["fieldName"] + "(0,layero, index);}catch(e){layer.msg('未实现clickcallback_" + $.businessCode+"_"+designO["fieldName"]+ "方法！', {icon: 5});}";*/
            html_ += " var iframeWin =  $(layero).find('iframe')[0].contentWindow;";
            html_ += " try{iframeWin.backDataToPage();}catch(e){layer.msg('未实现backDataToPage方法！', {icon: 5});}";
            html_ += " layer.close(index);";
            html_ += " },";
            html_ += " cancel: function() {}";
            html_ += " });";
            html_ += " }";
            html_ += "</script>";
        }
        
        if (type=="datetime"||type =="year"||type=="yymm"||type =="date"||type =="time") {
            html_ += "<input  "+disabled_+"   style=\"height: inherit;\"  ";
            html_ += " class=\"Wdate_"+designO["id"]+"\" ";
           if(type == "datetime"){
           	 html_ += " placeholder='yyyy-MM-dd HH:mm:ss'  ";
           }else if(type == "date"){
           	 html_ += " placeholder='yyyy-MM-dd' ";
           }else if(type == "year"){
           	html_ += " placeholder='yyyy' ";
           }else if(type == "yymm"){
           	html_ += " placeholder='yyyy-MM' ";
           }else if(type == "time"){
           	html_ += " placeholder='HH:mm:ss' ";
           }
            
            html_ += " tt=\""+type+"\" did='"+designO["id"]+"' type=\"text\" ";
            html_ += "id=\"" + id + "\" name=\"" + id + "\" value=\"\">";
        }
        html_ += "</div>";
        html_ += "</div>";
        html_ += "</div>";
        html_ += "</div>";
        /*console.log("---------------------html_--"+html_);*/
        return html_;
    },
    
    getLabelHtml: function(designId, type) {
    	 var has = designId in $.FieldsMap;
         var designO;
         if (has) {
             designO = $.FieldsMap[designId];
         }
         var html_ = "\n<div ";
         $.each($.Fields, function(index, val) {
             html_ += " design-" + val.id + "='" + designO[val.id] + "'";
         });
         html_ += " class='profile-user-info dropdiv' style='height: 98.5%;border:0px;background-color: #F6F6F6;'  >";
         html_ += "<div style='height: 100%;' class='profile-user-info'>";
         html_ += "<div class='profile-info-name' style='width: 80px;overflow: hidden;'>";
         html_ += "<text_content >" + designO["content"] + "</text_content>";
         html_ += "</div>";
         html_ += "</div>\n";
         html_ += "</div>\n";
         if ($.isEdit) {
             html_ += "<div class='canDragEl' ></div>";
         }
        return html_;
    },
    getRegionHtml: function(designId, type) {
      	 var has = designId in $.FieldsMap;
           var designO;
           if (has) {
               designO = $.FieldsMap[designId];
           }
           var disabled_=designO["isEdit"]=="N"?"true":"false";
           var html_ = "\n<div ";
           $.each($.Fields, function(index, val) {
               html_ += " design-" + val.id + "='" + designO[val.id] + "'";
           });
           html_ += " class='profile-user-info dropdiv' style='border:0px;'  >";
           html_ += "<div style='margin: 0 1px;' class='profile-user-info profile-user-info-striped'>";
           html_ += "<div class='profile-info-row' style='min-height: 35px;'>";
           html_ += "<div class='profile-info-name' >";
           html_ += "<text_content >" + designO["content"] + "</text_content>";
           html_ += "</div>";
           html_ += "<div class='profile-info-value' style='white-space: nowrap;";
           html_ += "word-wrap: normal;padding-left: 0px;'>";
           html_ += "<input id='"+designO["fieldName"]+"_province'  name='"+designO["fieldName"]+"_province' type='hidden' value=''> ";
           html_ += "<input id='"+designO["fieldName"]+"_city' name='"+designO["fieldName"]+"_city' type='hidden' value=''> ";
           html_ += "<input id='"+designO["fieldName"]+"_county' name='"+designO["fieldName"]+"_county' type='hidden' value=''> ";
           html_ += "<input id='"+designO["fieldName"]+"_address' name='"+designO["fieldName"]+"_address' type='hidden' value=''> ";
           html_ += "<input  style='font-size: 14px;width:98%;'  name='' value='' id='"+designO["fieldName"]+"_sel_city' readonly='readonly'  type='text' placeholder='请选择' autocomplete='off'>";
           html_ += "</div>\n";
           html_ += "</div>\n";
           html_ += "</div>\n";
           html_ += "</div>\n";
           
            html_ += "<script type='text/javascript'> var set_"+designO["fieldName"]+"_region_t=window.setInterval('$.setRegionDataObj_(\""+designO["fieldName"]+"\")',500); ";
            if(disabled_=="false"){
            html_ += "$('#"+designO["fieldName"]+"_sel_city').click(function (e) {";
            html_ += "SelCity(this,e,'"+designO["fieldName"]+"');";
	   		html_ += "});";
	   		html_ += "$('s').click(function (e) {";
	   		html_ += "var er=document.getElementById('"+designO["fieldName"]+"_sel_city');";
	   		html_ += "SelCity(er,e,'"+designO["fieldName"]+"');";
	   		html_ += "});";
            }
	   		html_ += "</script>";
           
           if ($.isEdit) {
               html_ += "<div class='canDragEl' ></div>";
           }
          return html_;
      },
      setRegionDataObj_: function(fieldName) {
    	  $.getJSON("editPageGenController.do?getRegionDataJson&mainId="+$.mainId+"&fieldName="+fieldName,function(resultData) {
    		  if($("#"+fieldName+"_sel_city").length>0){
        		  window.clearInterval(eval("set_"+fieldName+"_region_t"));
        		  var sel_city="";
        		  
        		  $("#"+fieldName+"_province").val(resultData.province);
        		  $("#"+fieldName+"_city").val(resultData.city);
        		  $("#"+fieldName+"_county").val(resultData.county);
        		  $("#"+fieldName+"_address").val(resultData.address);
        		  if(resultData.province!=""){
        			  sel_city+=resultData.province+"/";
        			  if(resultData.city!=""){
        				  sel_city+=resultData.city+"/";
        				  if(resultData.county!=""){
        					  sel_city+=resultData.county+"/";
        					  if(resultData.address!=""){
        						  sel_city+=resultData.address;
        					  }
        				  }
        			  }
        		  }
        		  $("#"+fieldName+"_sel_city").val(sel_city);
        	  }
			});
    	  
      },
    getDetailListTableHtml: function(linkBussCode) {
        var reHtml = $.getTemplateHtml1(linkBussCode);
        var html_ = "\n";
        html_ += "<div class='form-layout-top-toolbar' style=\"padding:1px;\">";
        html_ += "<table style=\"width:100%;border-spacing: 1px;border-collapse: inherit;\"  class='formtable' cellpadding='0' cellspacing='1'>";
        html_ += "<tr height=\"46px\" id='title_tr_" + linkBussCode + "'>";
        html_ += reHtml.html_2;
        html_ += "</tr>";
        html_ += "<tbody id=\"tbody_" + linkBussCode + "\">";
        html_ += reHtml.html_3;
        html_ += "</tbody>";
        html_ += "</table>";
        html_ += "<table  id=\"tbody_" + linkBussCode + "_template\" style=\"border-spacing: 1px;border-collapse: inherit;display:none\"  class='formtable' cellpadding='0' cellspacing='1'>";
        html_ += "<tr height=\"46px\" id='template_tr_" + linkBussCode + "' >";
        html_ += reHtml.html_1;
        html_ += "  </tr>";
        html_ += "</table>";
        html_ += "</div>";
        return html_;
    },
    getTemplateButton: function(formId) {
        $.ajaxSettings.async = false;//禁用异步操作
        var html_1 = "";
        $.getJSON( "designController.do?getButtonList&formId="+formId+"&isEdit="+$.isEdit+"&defineCode="+$.businessCode, "", function(resultData) {
        	 $.each(resultData, function(n, node) {
	        	html_1 += "<div type=\"button\" class=\"layui-btn layui-btn-normal\" id="+node.buttonCode+" >";
	        	html_1 += "<i class='"+node.buttonIcon+"'></i>&nbsp;"+node.buttonName;
	        	html_1 += "</div>";
        	 });
        });
        $.ajaxSettings.async = true;//恢复异步操作
        return html_1;
    },
    getEndButton: function() {
        $.ajaxSettings.async = false;
        var html_1 = "";
        $.getJSON( "designController.do?getEndButton&bussTemplateId=" + $.bussTemplateId + "&versionNum=" + $.versionNum+"&defineCode="+$.businessCode+"", "", function(resultData) {
        	if(resultData.length>0){
	        	var menu = new Menu("#myMenu");
	       	 	var item1 = new Item("icon-plus");
	       	 	menu.add(item1);
	        	$.each(resultData, function(n, node) {
	        		var item2 = new Item(node.buttonIcon,'#'+Math.floor(Math.random()*16777215).toString(16),node.buttonName,"$."+node.buttonType+"()");
		        	menu.add(item2);
	        	 });
	        	 $(document).delay(50).queue(function(next) {
	        	     menu.open();
	        	     next();
	        	     $(document).delay(1000).queue(function(next) {
	        	         menu.close();
	        	         next();
	        	     });
	        	 });
        	}
        });
        return html_1;
    },
    print:function() {
    	layer.msg('对不起，您无打印权限',{icon: 5});
    	return;
    },
    taskInst:function() {
    	layer.open({
    		  type: 2,
    		  title:"办理记录",
    		  shadeClose: false, /*开启遮罩关闭*/
    		  area: ["60%", "80%"], /*宽高*/
    		  content: "editPageGenController.do?getTransactionHistory&PROJECTID="+$.mainId,
    		  btn: ['关闭']
    		,cancel: function(){}
    		});
    },
    flowChart:function() {
    	
    },
    fileDow:function() {
    	layer.msg('对不起，您无下载权限',{icon: 5});
    	return;
    },
    wClose:function() {
    	myConfirmDialog("您确定要关闭当前页面吗？", function() {
    		window.close();
		}, function() {
			return true;
		},"");
    },
    getTabList: function(formId) {
        var resultData_;
        $.ajax({
        	async : false,
			cache : false,
            type: "GET",
            url:  "designController.do?getTabList&formId="+formId+"&defineCode="+$.businessCode,
            success: function(resultData) {
            	resultData_=resultData;
            },
            error: function(data) {
            }
        });
        return resultData_;
    },
    getTemplateHtml1: function(linkBussCode) {
        var reHtml = new Object();
        var html_2 = "",
            html_1 = "",
            html_3 = "";
        $.ajax({
        	async : false,
			cache : false,
            type: "GET",
            url:  "designController.do?getTableBody&linkBussCode=" + linkBussCode + "&bussTemplateId=" + $.bussTemplateId + "&versionNum=" + $.versionNum,
            success: function(resultData) {
            	html_3 += "<tr height=\"20px\" class=\"nodata\" >";
                var isShowLength = resultData.length;
                $.each(resultData, function(n, node) {
                    if (node.is_list_hide == "Y" || node.is_list_hide == "1") {
                        isShowLength--;
                    }
                });
                html_3 += "<td class='value' align=\"center\" colspan='" + (isShowLength + 1) + "'>";
                html_3 += "  暂无数据";
                html_3 += "  </td>";
                html_3 += "  </tr>";
                html_2 = "<th align=\"center\" style='width:60px;' >操作</th>";
                $.each(resultData, function(n, node) {
                    var isHide = node.is_list_hide == "Y" || node.is_list_hide == "1" ? "none" : "";
                    html_2 += "<th align='center' style='display:" + isHide + "'>";
                    html_2 += node.content;
                    html_2 += "</th>";
                });
                html_1 += "<td align=\"center\" style='width:60px;' class=\"value\" >" + "<input type='checkbox' name='ck' /></td>";
                $.each(resultData, function(n, node) {
                	 var disabled_=node.is_edit=="N"?"disabled='true'":"";
                	 disabled_=($.isEnd=="true")?"disabled='true'":disabled_;
                	 var id=linkBussCode+".[#index#]."+node.field_name;
                    var isHide = node.is_list_hide == "Y" || node.is_list_hide == "1" ? "none" : "";
                    html_1 += "<td align=\"center\" class=\"value\"  style='display:" + isHide + "' >";
                    if (node.show_type == "datetime" ||
                    		node.show_type == "time" 
                    	|| node.show_type == "year" 
                    		|| node.show_type == "yymm" 
                    			|| node.show_type == "date") {
                        html_1 += " <input  "+disabled_+"    type='text' ";
                        html_1 += " id='" + id + "' name='" + id + "'   value=\"\"";
                        html_1 += " fieldAlert=\"" + node.field_alert + "\" style='height:inherit;' did='"+node.field_name+"' class=\"Wdate_"+node.field_name+"\" ";
/*                          if(node.show_type == "datetime"){
                        	  html_1 += " onclick=\"WdatePicker({dateFmt: 'yyyy-MM-dd HH:mm:ss'})\" ";
	                       }else if(node.show_type == "date"){
	                    	   html_1 += " onclick=\"WdatePicker({dateFmt: 'yyyy-MM-dd'})\" ";
	                       }else if(node.show_type == "year"){
	                    	   html_1 += " onclick=\"WdatePicker({dateFmt: 'yyyy'})\" ";
	                       }else if(node.show_type == "yymm"){
	                    	   html_1 += " onclick=\"WdatePicker({dateFmt: 'yyyy-MM'})\" ";
	                       }else if(node.show_type == "time"){
	                    	   html_1 += " onclick=\"WdatePicker({dateFmt: 'HH:mm:ss'})\" ";
	                       }*/
                        
                        if(node.show_type == "datetime"){
                          	 html_ += " placeholder='yyyy-MM-dd HH:mm:ss'  ";
                          }else if(node.show_type == "date"){
                          	 html_ += " placeholder='yyyy-MM-dd' ";
                          }else if(node.show_type == "year"){
                          	html_ += " placeholder='yyyy' ";
                          }else if(node.show_type == "yymm"){
                          	html_ += " placeholder='yyyy-MM' ";
                          }else if(node.show_type == "time"){
                          	html_ += " placeholder='HH:mm:ss' ";
                          }
                        
                        
                        html_1 += " >";
                    } else if (node.show_type == 'textarea') {
                        html_1 += " <textarea  "+disabled_+"   fieldAlert=\"" + node.field_alert + "\"  style='height:61px'  ";
                        html_1 += " id='" +id + "'   name='" + id + "'  ></textarea>";
                    } 
                    else if (node.show_type == 'list'||node.show_type == 'select') {
                    	
                    	var dataObj = $.getDictDataHtml(node.id,node.select_id,node.field_href);
                    	html_1 += "<select "+disabled_+"  style=\"height: 30px;width:100%;\"  nullmsg='"+node.field_alert+"' id=\"" +id;
            			html_1 += "\" name=\"" + id + "\">   ";
            			html_1 += "<option value=\"\" >请选择</option>   ";
            			
                    	if(dataObj != null && dataObj!=""){
                    		var temhtml = "";
                        	for(var k=0;k<dataObj.count;k++ ){
                        		var json = dataObj.resultList[k];
                        		temhtml+=" <option value=\""+json.typecode+"\" selected=\"\">"+json.typename+"</option>  ";
                        	}
                        	html_1 += temhtml;
                        	/*console.log("---------------------js-checkbox--"+temhtml);*/
                    	}
                    	html_1 += "</select> ";
                    }
                    else if (node.show_type == 'popup') {
                        html_1 += " <input  "+disabled_+" ";
                        html_1 += " id='" + id + "'  name='" + id + "' ";
                        html_1 += " type=\"hidden\"  class=\"inputxt\"  value=\"\">";
                        html_1 += " <input  "+disabled_+" ";
                        html_1 += " id='showName_" + id + "' ";
                        html_1 += " name='showName_" + id + "' ";
                        html_1 += " type=\"text\" style=\"width:98%\" ";
                        html_1 += " readonly=\"readonly\" class=\"inputxt\"  fieldAlert=\"" + node.field_alert + "\"  placeholder=\"请选择" + node.content + "\"  value=\"\">";
                        html_1 += "<div class='"+(disabled_!=""?"grid-stack-item-shortcut-hide'":"grid-stack-item-shortcut")+"'  >";
                        html_1 += " <i class=\"iconfont\" style=\"cursor: pointer;\" title=\"选择\" onclick=\"choose_"+node.id + "('#index#','" + node.field_href + "','" + node.window_width + "','" + node.window_height + "','"+node.input_id+"','"+node.select_id+"','"+node.where_para+"')\">&#xe613;</i>";
                        html_1 += " <i class=\"iconfont\" style=\"cursor: pointer;font-size:19px;\" title=\"清除\" onclick=\"clearAll_"+node.id + "('#index#');\">&#xe636;</i>";
                        html_1 += "</div>";
                        if(disabled_==""){
                        	html_1 += " <script type=\"text/javascript\">";
                            html_1 += " function clearAll_"+node.id + "(index_) {";
                            html_1 += " try{clearAll_"+linkBussCode+"_"+node.field_name+"(index_);}catch(e){";
                            html_1 += "$('#" + linkBussCode+"\\.\\[index_\\]\\."+node.field_name + "').val('');";
                            html_1 += "$('#showName_" + linkBussCode+"\\.\\[index_\\]\\."+node.field_name + "').val('');";
                    		html_1 += "}";
                            html_1 += " }";
                            html_1 += " function choose_" + node.id + "(newindex_,fieldHref,windowWidth_,windowHeight_,inputId,selectId,wherePara) {";
                            html_1 += " if(fieldHref==''||fieldHref==null){";
                            html_1 += " layer.msg('请先配置数据来源！', {icon: 5});";
                            html_1 += " return false;";
                            html_1 += " }";
                            html_1 += " var windowWidth = windowWidth_!=null&&windowWidth_!=''&&windowWidth_!='null'?windowWidth_:document.body.offsetWidth*(parseFloat('100')/100);";
                            html_1 += " var windowHeight = windowHeight_!=null&&windowHeight_!=''&&windowHeight_!='null'?windowHeight_:document.body.offsetHeight*(parseFloat('100')/100)-100;";
                            html_1 += " if(windowWidth.toString().indexOf('%')!=-1){";
                            html_1 += " windowWidth = document.body.offsetWidth*(parseFloat(windowWidth)/100);";
                            html_1 += " }";
                            html_1 += " if(windowHeight.toString().indexOf('%')!=-1){";
                            html_1 += " windowHeight =document.body.offsetHeight*(parseFloat(windowHeight)/100)-100;";
                            html_1 += " }";
                            html_1 += " windowHeight=parseFloat(windowHeight);";
                            html_1 += " windowHeight=windowHeight;";
                            html_1 += " layer.open({";
                            html_1 += " type: 2,";
                            html_1 += " title: '请选择',";
                            html_1 += " maxmin: true,";
                            html_1 += " shadeClose: true,";
                            html_1 += " area: [windowWidth+'px', windowHeight+'px'],";
                            html_1 += " content: fieldHref,";
                            html_1 += " btn: ['确定', '关闭'],";
                            html_1 += " yes: function(index, layero) {";
                            html_1 += " try{clickcallback_" + linkBussCode+"_"+node.field_name + "(newindex_,layero, index);}catch(e){layer.msg('未实现clickcallback_" + linkBussCode+"_"+node.field_name + "方法！', {icon: 5});}";
                            html_1 += " layer.close(index);";
                            html_1 += " },";
                            html_1 += " cancel: function() {}";
                            html_1 += " });";
                            html_1 += " }";
                            html_1 += " </script>";
                        }
                    } else {
                        html_1 += " <input    "+disabled_+"   type='text' ";
                        html_1 += " id='" + id + "'   name='" + id + "' ";
                        html_1 += " value=\"\"  fieldAlert=\"" + node.field_alert + "\" style='' ";
                        html_1 += " >";
                    }
                    html_1 += "  </td>";
                });
            },
            error: function(data) {
            }
        });
        reHtml.html_1 = html_1;
        reHtml.html_2 = html_2;
        reHtml.html_3 = html_3;
        return reHtml;
    },
getDetailListHtml1: function(designId, type) {
    	
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ = "<div ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += " class=\" profile-user-info dropdiv \"   style=\"border:0px;overflow-y: hidden;\">";
        html_ += "<div class='para-title level-2' label-module='para-title'  >";
        html_ += "<div class='title-text'><text_content >" + designO["content"] + "</text_content></div>";
        html_ += "</div>\n";
        html_ += $.getDetailListToolbarHtml(designO["fieldName"],designO["linkBussCode"]);
        
        html_ += $.getDetailListTableHtml(designO["linkBussCode"]);
        if ($.isEdit) {
            html_ += "<div class=\"form-layout-toolbar\">" + "<span class=\"edit-btn\" onclick='$.designList(this)'>设计列表</span>";
            html_ += "</div>";
            html_ += "<div class=\"form-layout-mask\">";
            html_ += "</div>";
        }
        if (!$.isEdit) {
            html_ += " <script type='text/javascript'>";
            html_ += " function resetTrNum_" + designO["linkBussCode"] + "(tableId) {";
            html_ += "         	$tbody = $('#'+tableId);";
            html_ += "         	var ii;";
            html_ += "         	$tbody.find('>tr').each(function(i){";
            html_ += "         		$(':input, select,button,a,i', this).each(function(){";
            html_ += "         			var $this = $(this), name = $this.attr('name'),id=$this.attr('id'),onclick_str=$this.attr('onclick'),onblur_str=$this.attr('onblur'), val = $this.val();";
            html_ += "         			if(name!=null){";
            html_ += "         				if (name.indexOf('#index#') >= 0){";
            html_ += "         					$this.attr('name',name.replace('#index#',i));";
            html_ += "         				}else{";
            html_ += "         					var s = name.indexOf('[');";
            html_ += "         					var e = name.indexOf(']');";
            html_ += "         					var new_name = name.substring(s+1,e);";
            html_ += "         					$this.attr('name',name.replace(/[^\[]+(?=\])/g,i));";
            html_ += "         				}";
            html_ += "         			}";
            html_ += "         			if(onblur_str!=null){";
            html_ += "         				if (onblur_str.indexOf('#index#') >= 0){";
            html_ += "         					$this.attr('onblur',onblur_str.replace('#index#',i));";
            html_ += "         				}else{";
            html_ += "         					$this.attr('onblur',onblur_str.replace(/\d+/g,i));";
            html_ += "         				}";
            html_ += "         			}";
            html_ += "         			if(id!=null){";
            html_ += "         				if (id.indexOf('#index#') >= 0){";
            html_ += "         					$this.attr('id',id.replace('#index#',i));";
            html_ += "         				}else{";
            html_ += "         					var s = id.indexOf('[');";
            html_ += "         					var e = id.indexOf(']');";
            html_ += "         					var new_id = id.substring(s+1,e);";
            html_ += "         					$this.attr('id',id.replace(/[^\[]+(?=\])/g,i));";
            html_ += "         				}";
            html_ += "         			}";
            html_ += "         			if(onclick_str!=null){";
            html_ += "         				if (onclick_str.indexOf('#index#') >= 0){";
            html_ += "         					$this.attr('onclick',onclick_str.replace(/#index#/g,i));";
            html_ += "         				}else{";
            html_ += "         				}";
            html_ += "         			}";
            html_ += "         		});";
            html_ += "         		$(this).find(\"div[name='xh']\").html(i+1);";
            html_ += "         		ii=i;";
            html_ += "         	});";
            html_ += "         }";
            html_ += "         function addBtn_" + designO["fieldName"] + "(id){";
            
            html_ +=" var grid = $('#designMainGrid_show').find('.grid-stack').data('gridstack');";
            html_ += "var nowY=parseInt($(\"[data\-gs\-design\-id='"+designO["id"]+"']\").attr('data\-gs\-y'));";
            html_ += "var nowHeight=parseInt($(\"[data\-gs\-design\-id='"+designO["id"]+"']\").attr('data\-gs\-height'));";
            html_ += "var prefix = '.' + grid.opts._class + ' .' + grid.opts.item_class;";
            html_ += "$('.'+grid.opts._class).height(($('.'+grid.opts._class).height()+grid.opts.cell_height));";
            html_ += "for (var i = grid._styles._max; i < (grid._styles._max+1); ++i) {";
			 html_ += "GridStackUI.Utils.insert_css_rule(grid._styles,";
			 html_ += "prefix + '[data-gs-height=\"' + (i + 1) + '\"]',";
			 html_ += "'height: ' + (grid.opts.cell_height * (i + 1) + grid.opts.vertical_margin * i) + 'px;',";
			 html_ += "i";
			 html_ += ");";
			 html_ += "GridStackUI.Utils.insert_css_rule(grid._styles,";
			 html_ += "prefix + '[data-gs-min-height=\"' + (i + 1) + '\"]',";
			 html_ += "'min-height: ' + (grid.opts.cell_height * (i + 1) + grid.opts.vertical_margin * i) + 'px;',";
			 html_ += "i";
			 html_ += ");";
			 html_ += "GridStackUI.Utils.insert_css_rule(grid._styles,";
			 html_ += "prefix + '[data-gs-max-height=\"' + (i + 1) + '\"]',";
			 html_ += "'max-height: ' + (grid.opts.cell_height * (i + 1) + grid.opts.vertical_margin * i) + 'px;',";
			 html_ += "i";
			 html_ += ");";
			 html_ += "GridStackUI.Utils.insert_css_rule(grid._styles,";
			 html_ += "prefix + '[data-gs-y=\"' + i + '\"]',";
			 html_ += "'top: ' + (grid.opts.cell_height * i + grid.opts.vertical_margin * i) + 'px;',";
			 html_ += "i";
			 html_ += ");";
			 html_ += "}grid._styles._max=(grid._styles._max+1);";
            html_ += "$(\"[data\-gs\-design\-id='"+designO["id"]+"']\").attr('data\-gs\-height',(nowHeight+1));";
            html_ += "$('.grid\-stack\-item').each(function(index,item) {";
        	html_ += "if(parseInt($(item).attr('data\-gs\-y'))>nowY&&$(item).attr('data\-gs\-design\-id')!='"+designO["id"]+"'){";
        	html_ += "$(item).attr('data\-gs\-y',(parseInt($(item).attr('data\-gs\-y'))+1));";
        	html_ += "}";
    		html_ += "});";
            html_ += "     		 $('#'+id).find('.nodata').remove();var tr =  $('#'+id+'_template tr').clone();";
            html_ += "    	 	 $('#'+id).append(tr);";
            html_ += "    	 	 resetTrNum_" + designO["linkBussCode"] + "(id);$.designform.render(null);";
            html_ += "        } ";
            html_ += "    	function del_" + designO["fieldName"] + "(id){";
            html_ += "var nowY=parseInt($(\"[data\-gs\-design\-id='"+designO["id"]+"']\").attr('data\-gs\-y'));";
            html_ += "var nowHeight=parseInt($(\"[data\-gs\-design\-id='"+designO["id"]+"']\").attr('data\-gs\-height'));";
            html_ += "var cl=$('#'+id).find('input:checked').length;";
            html_ += "$(\"[data\-gs\-design\-id='"+designO["id"]+"']\").attr('data\-gs\-height',(nowHeight-cl));";
            html_ += "$('.grid\-stack\-item').each(function(index,item) {";
        	html_ += "if(parseInt($(item).attr('data\-gs\-y'))>nowY&&$(item).attr('data\-gs\-design\-id')!='"+designO["id"]+"'){";
        	html_ += "$(item).attr('data\-gs\-y',(parseInt($(item).attr('data\-gs\-y'))-cl));";
        	html_ += "}";
    		html_ += "});";
    		html_ +=" var grid = $('#designMainGrid_show').find('.grid-stack').data('gridstack');";
    		 html_ += "$('.'+grid.opts._class).height(($('.'+grid.opts._class).height()-grid.opts.cell_height*cl));";
    		 
            html_ += "          	$('#'+id).find('input:checked').parent().parent().remove();   ";
            html_ += "            resetTrNum_" + designO["linkBussCode"] + "(id); ";
            html_ += "        } ";
            html_ += " </script>";
            }
        $.getTemplateHtml1(designO["linkBussCode"]);
        
        
        return html_;
    },
    
    getDetailListToolbarHtml: function(fieldName,linkBussCode) {
    	 var html_ = "";
    	if (!$.isEdit) {
        	if(!($.isEnd=="true")){
        		 html_ += "<div class=\"form-layout-top-toolbar\">";
                 html_ += "<span class=\"edit-btn\" onclick=\"addBtn_" + fieldName + "('tbody_" + linkBussCode + "');\" >添加行</span>";
                 html_ += "<span class=\"edit-btn\" onclick=\"del_" + fieldName+ "('tbody_" + linkBussCode + "');\" >移除行</span>";
                 html_ += "</div>";
        	}
        }
    	return html_;
    },
    getDetailListTabHtml: function(designId, type) {
    	
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var tabObj= $.getTabList(designO["fieldName"]);
        var html_ = "\n";
        html_ = "<div ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += " class=\" profile-user-info dropdiv \"   style=\"border:0px;overflow-y: hidden;\">";
        html_ += "<div class='para-title level-2' label-module='para-title'  >";
        html_ += "<div class='title-text'><text_content >" + designO["content"] + "</text_content></div>";
        html_ += "</div>\n";
        if ($.isEdit) {
            html_ += "<div class=\"form-layout-toolbar\">" + "<span class=\"edit-btn\" onclick='$.designTab(this)'>设计页签</span>";
            html_ += "</div>";
            html_ += "<div class=\"form-layout-mask\">";
            html_ += "</div>";
        }
        html_ += "<div class='layui-tab layui-tab-card'>";
        html_ += "<ul class='layui-tab-title' >";
        if(tabObj.length>0){
        	for(var i=0;i<tabObj.length;i++){
        		html_ += "<li "+(i==0?"class='layui-this'":"")+">"+tabObj[i].tabName+"</li>";
        	}
        }
		html_ += "</ul>";
		html_ += "<div class='layui-tab-content' style='height: 280px;overflow-y: auto;'>";
		if(tabObj.length>0){
        	for(var i=0;i<tabObj.length;i++){
        		html_ += "<div class='layui-tab-item "+(i==0?"layui-show":"")+"' >";
        		html_ += $.getDetailListToolbarHtml(designO["fieldName"],tabObj[i].linkBussCode);
        		html_ += $.getDetailListTableHtml(tabObj[i].linkBussCode);
        		html_ += "</div>";
        		$.getTemplateHtml1(tabObj[i].linkBussCode);
        	}
        }
		
        html_ += "</div>";
    	html_ += "</div>";
    	if (!$.isEdit) {
            html_ += " <script type='text/javascript'>";
            html_ += "layui.use(['element'], function(){";
        	html_ += "layui_element_" + designO["fieldName"] + " = layui.element;"; /*元素操作*/
    		html_ += "});";
            html_ += " function resetTrNum_" + designO["fieldName"] + "(tableId) {";
            html_ += "         	$tbody = $('#'+tableId);";
            html_ += "         	var ii;";
            html_ += "         	$tbody.find('>tr').each(function(i){";
            html_ += "         		$(':input, select,button,a,i', this).each(function(){";
            html_ += "         			var $this = $(this), name = $this.attr('name'),id=$this.attr('id'),onclick_str=$this.attr('onclick'),onblur_str=$this.attr('onblur'), val = $this.val();";
            html_ += "         			if(name!=null){";
            html_ += "         				if (name.indexOf('#index#') >= 0){";
            html_ += "         					$this.attr('name',name.replace('#index#',i));";
            html_ += "         				}else{";
            html_ += "         					var s = name.indexOf('[');";
            html_ += "         					var e = name.indexOf(']');";
            html_ += "         					var new_name = name.substring(s+1,e);";
            html_ += "         					$this.attr('name',name.replace(/[^\[]+(?=\])/g,i));";
            html_ += "         				}";
            html_ += "         			}";
            html_ += "         			if(onblur_str!=null){";
            html_ += "         				if (onblur_str.indexOf('#index#') >= 0){";
            html_ += "         					$this.attr('onblur',onblur_str.replace('#index#',i));";
            html_ += "         				}else{";
            html_ += "         					$this.attr('onblur',onblur_str.replace(/\d+/g,i));";
            html_ += "         				}";
            html_ += "         			}";
            html_ += "         			if(id!=null){";
            html_ += "         				if (id.indexOf('#index#') >= 0){";
            html_ += "         					$this.attr('id',id.replace('#index#',i));";
            html_ += "         				}else{";
            html_ += "         					var s = id.indexOf('[');";
            html_ += "         					var e = id.indexOf(']');";
            html_ += "         					var new_id = id.substring(s+1,e);";
            html_ += "         					$this.attr('id',id.replace(/[^\[]+(?=\])/g,i));";
            html_ += "         				}";
            html_ += "         			}";
            html_ += "         			if(onclick_str!=null){";
            html_ += "         				if (onclick_str.indexOf('#index#') >= 0){";
            html_ += "         					$this.attr('onclick',onclick_str.replace(/#index#/g,i));";
            html_ += "         				}else{";
            html_ += "         				}";
            html_ += "         			}";
            html_ += "         		});";
            html_ += "         		$(this).find(\"div[name='xh']\").html(i+1);";
            html_ += "         		ii=i;";
            html_ += "         	});";
            html_ += "         }";
            html_ += "         function addBtn_" + designO["fieldName"] + "(id){";
            html_ += "     		 $('#'+id).find('.nodata').remove();var tr =  $('#'+id+'_template tr').clone();";
            html_ += "    	 	 $('#'+id).append(tr);";
            html_ += "    	 	 resetTrNum_" + designO["fieldName"] + "(id);";
            html_ += "        } ";
            html_ += "    	function del_" + designO["fieldName"] + "(id){";
            html_ += "          	$('#'+id).find('input:checked').parent().parent().remove();   ";
            html_ += "            resetTrNum_" + designO["fieldName"] + "(id); ";
            html_ += "        } ";
            html_ += " </script>";
            }
        return html_;
    },
    getDetailListHtml2: function(designId, type) {
        var has = designId in $.FieldsMap;
        var designO;
        if (has) {
            designO = $.FieldsMap[designId];
        }
        var html_ = "\n";
        html_ = "<div ";
        $.each($.Fields, function(index, val) {
            html_ += " design-" + val.id + "='" + designO[val.id] + "'";
        });
        html_ += " class=\" profile-user-info dropdiv\"    style=\"border:0px;overflow-y: hidden;\">";
        html_ += "<div class='para-title level-2' label-module='para-title' >";
        html_ += "<div class='title-text'><text_content >" + designO["content"] + "</text_content></div>";
        html_ += "</div>\n";
        if (!$.isEdit) {
            html_ += "<div class=\"form-layout-top-toolbar\">";
            html_ += "<span class=\"edit-btn\">新增</span>";
            html_ += "<span class=\"edit-btn\">修改</span>";
            html_ += "<span class=\"edit-btn\">删除</span>";
            html_ += "</div>";
        }
        html_ += getDetailListTableHtml(designO["linkBussCode"]);
        if ($.isEdit) {
            html_ += "<div class=\"form-layout-toolbar\">" + "<span class=\"edit-btn\" onclick='$.designList(this)'>设计列表</span>" + "<span class=\"addColum-btn\" onclick='designForm(this)'>设计表单</span>";
            html_ += "</div>";
            html_ += "<div class=\"form-layout-mask\">";
            html_ += "</div>";
        }
        return html_;
    },
    addButton: function(ths) {
    	saveHtml('false');/*保存表单*/
        var ppselect = $(ths).closest('.grid-stack-item');
        var fieldname = ppselect.find("[design-id]").attr("design\-fieldname");
        layer.open({
            type: 2,
            title: "按钮列表",
            shadeClose: false, /* 开启遮罩关闭*/
            area: ["50%", "50%"], /* 宽高*/
            content: "designController.do?cgformButton&defineCode="+$.businessCode+"&formId=" + fieldname,
            btn: ['关闭'],
            yes: function(index, layero) {
            	window.location.reload();
            },
            cancel: function() { window.location.reload();}
        });
    },
    designList: function(ths) {
    	
        var ppselect = $(ths).closest('.grid-stack-item');
        var bussCode = ppselect.find("[design-linkBussCode]").attr("design\-linkBussCode");
        if (bussCode == "" || bussCode == null) {
            parent.layer.msg("请先关联业务编码", {
                icon: 5
            });
            return false;
        }
        saveHtml('false');/*保存表单*/
        layer.open({
            type: 2,
            title: "配置主列表",
            shadeClose: false, /* 开启遮罩关闭*/
            area: ["90%", "90%"], /* 宽高*/
            content: "designController.do?mconfigure&bussCode=" + bussCode + "&versionNum=-1",
            btn: ['保存', '关闭'],
            yes: function(index, layero) {
                var form1 = parent.layer.getChildFrame("form", index);
                $.ajax({
                    type: "POST",
                    url: $(form1).attr("action"),
                    data: $(form1).serialize(),
                    success: function(data) {
                        parent.layer.close(index); /* 如果设定了yes回调，需进行手工关闭*/
                        parent.layer.msg('操作成功！', {
                            icon: 1
                        });
                        window.location.reload();
                    },
                    error: function(data) {
                        parent.layer.msg("error:" + data.responseText, {
                            icon: 5
                        });
                    }
                });
            },
            cancel: function() {}
        });
    },
    designTab: function(ths) {
    	saveHtml('false');/*保存表单*/
    	var ppselect = $(ths).closest('.grid-stack-item');
        var fieldname = ppselect.find("[design-id]").attr("design\-fieldname");
        layer.open({
            type: 2,
            title: "设计页签",
            shadeClose: false, /* 开启遮罩关闭*/
            area: ["50%", "50%"], /* 宽高*/
            content: "designController.do?cgformTab&defineCode="+$.businessCode+"&formId=" + fieldname,
            btn: ['关闭'],
            yes: function(index, layero) {
            	window.location.reload();
            },
            cancel: function() { window.location.reload();}
        });
    },
    delPic:function(ttis,fieldName) {
		var id = $(ttis).attr("id");
		myConfirmDialog("您确定要删除吗？", function() {
			$.ajax({
				async : false,
				cache : false,
				type : 'POST',
				url : "cgformAttchController.do?delFile&id=" + id,/* 请求的action路径*/
				error : function() {/* 请求失败处理函数*/
				},
				success : function(data) {
					layer.msg('删除成功！', {
						icon : 1
					});
					$('#ximg_'+fieldName).html("");
					$.getVFormPicDataJson();
					return true;
				}
			});
		}, function() {
			return true;
		}, "");
	},
	delFile:function(id,ts) {
		myConfirmDialog("您确定要删除吗？", function() {
			$.ajax({
				async : false,
				cache : false,
				type : 'POST',
				url : "cgformAttchController.do?delFile&id=" + id,/* 请求的action路径*/
				error : function() {/* 请求失败处理函数*/
				},
				success : function(data) {
					layer.msg('删除成功！', {icon : 1});
					$(ts).closest('.crumbs-nav-item').remove();
					return true;
				}
			});
		}, function() {
			return true;
		}, "");
	},
    designForm: function() {alert(111);},
    checkedEditWidget_: function(id) {
    	$(id).click(function(){
    		$.editWidget_(this);
    		$.t1(this);
    		designJsEvent();
    	});
    }, 
    t1: function(t) {
    		var ppselect = $(t).closest('.grid-stack-item');
    		$(".field-actions").hide();
    		$(ppselect).find(".field-actions").show();
    		$('.grid-stack-item').removeClass("myselect");
    		$(ppselect).addClass("myselect");
    },
    contextMenuByDiv: function(id) {
    	$(id).contextMenu({
    		/**
    	    width: 110, // width
    	    itemHeight: 30, // 菜单项height
    	    bgColor: "#333", // 背景颜色
    	    color: "#fff", // 字体颜色
    	    fontSize: 12, // 字体大小
    	    hoverColor: "#fff", // hover字体颜色
    	    hoverBgColor: "#99CC66", // hover背景颜色
    	    */
    	    target: function(ele) { /* 当前元素--jq对象*/
    	        $.editWidget_(ele);
    	        $.t1(ele);
    	    },
    	    menu: [{ /* 菜单项*/
    	            text1: "必填",
    	            text2: "取消必填",
    	            valText1: "Y",
    	            valText2: "N",
    	            /*src:"",*/
    	            filedName: "isNotnull",
    	            callback: function(ele,val_) {
    	            	$("#FieldSetTable #isNotnull").val(val_).trigger("change");
    	            }
    	        },
    	        {
    	            text1: "表单隐藏",
    	            text2: "表单显示",
    	            valText1: "N",
    	            valText2: "Y",
    	          /*src:"",*/
    	            filedName: "isFormHide",
    	            callback: function(ele,val_) {
    	                $("#FieldSetTable #isFormHide").val(val_).trigger("change");
    	            }
    	        },
    	        {
    	            text1: "删除控件",
    	            text2: "删除控件",
    	            valText1: "Y",
    	            valText2: "N",
    	            filedName: "isShow",
    	            callback: function(ele,val_) {
    	            	$(".select").closest('.grid-stack-item').find(".field-actions a[type='remove']").click();
    	            }
    	        }
    	    ]
    	});
    
    },
    designBinding: function() {
        $("#formobj_1_").on("input", "input[type=text],textarea", function() { /* 绑定属性配置中的所有输入时的动作*/
        	var se=$("#formobj_1_ .layui-tab-title").find(".layui-this").attr("lay\-id");
        	if(se=="FieldSet"){
	            var ppselect = $(".select").closest('.grid-stack-item');
	            var selectId = ppselect.find("[design-id]").attr("design\-id");
	            if (ppselect.find("text_" + $(this).attr("name")).length > 0) {
	                ppselect.find("text_" + $(this).attr("name")).text($(this).val());
	            }
	            if (ppselect.find("[" + $(this).attr("name") + "]").length > 0) {
	                ppselect.find("[" + $(this).attr("name") + "]").attr($(this).attr("name"), $(this).val());
	            }
	            if (ppselect.find("[design-" + $(this).attr("name") + "]").length > 0) {
	                ppselect.find("[design-" + $(this).attr("name") + "]").attr("design\-" + $(this).attr("name"), $(this).val());
	            }
            	$.FieldsMap[selectId][$(this).attr("name")] = $(this).val();
            	$("body").attr("onbeforeUnload","return '';");
            }
            if(se=="formSet"){
            	$.FormDataMap[$(this).attr("name")] = $(this).val();
            	$("body").attr("onbeforeUnload","return '';");
            }
            
        }).on("click", "input[type=checkbox],input[type=radio]", function() {
            var ppselect = $(".select").closest('.grid-stack-item');
            var selectId = ppselect.find("[design-id]").attr("design\-id");
            alert("正在建设");
        }).on("change", "select", function() {
        	
        	var se=$("#formobj_1_ .layui-tab-title .layui-this").attr("lay\-id");
        	if(se=="FieldSet"){
	            var ppselect = $(".select").closest('.grid-stack-item');
	            var selectId = ppselect.find("[design-id]").attr("design\-id");
	            if (ppselect.find("text_" + $(this).attr("name")).length > 0) {
	                if ($(this).val() == "Y") {
	                    ppselect.find("text_" + $(this).attr("name")).text("*");
	                } else {
	                    ppselect.find("text_" + $(this).attr("name")).text("");
	                }
	                $.FieldsMap[selectId][$(this).attr("name")] = $(this).val();
	            }
	            if (ppselect.find("[design-" + $(this).attr("name") + "]").length > 0) {
	                ppselect.find("[design-" + $(this).attr("name") + "]").attr("design\-" + $(this).attr("name"), $(this).val());
	                $.FieldsMap[selectId][$(this).attr("name")] = $(this).val();
	                $("body").attr("onbeforeUnload","return '';");
	            }
	            /*
	            if ($(this).attr("name") == "showType") {
	                delete_widget_($.FieldsMap[selectId]);
	                $.FieldsMap[selectId][$(this).attr("name")] = $(this).val();
	                update_widget_($.FieldsMap[selectId]);
	            }
	            */
	            if ($(this).attr("name") == "isFormHide") {
	                if ($(this).val() == "Y") {
	                    $.FieldsMap[selectId].isFormHide = "Y";
	                    delete_widget_($.FieldsMap[selectId]);
	                    add_new_widget_hide($.FieldsMap[selectId].showType, selectId);
	                } else {
	                    $.FieldsMap[selectId].isFormHide = "N";
	                    delete_widget_hide($.FieldsMap[selectId]);
	                    add_new_widget_($.FieldsMap[selectId].showType, selectId);
	                }
	                $("body").attr("onbeforeUnload","return '';");
	            }
	            if ($(this).attr("name") == "isShow") {
	            	var grid = $("#designMainGrid_show").find('.grid-stack').data('gridstack');
	            	if ($(this).val() == "N") {
	            		 try {
	            		$.FieldsMap[selectId].isShow="N";/*设置表单显示为 不显示*/
	                	grid.remove_widget(ppselect);
	                	loadHideForm();/*刷新左侧隐的表单不显示字段*/
	            		 } catch (e) {}
	            	}
	            }
        	}
        	if(se=="formSet"){
            	$.FormDataMap[$(this).attr("name")] = $(this).val();
            	$("body").attr("onbeforeUnload","return '';");
            }
        });
        $(".grid-stack").find("input").on("click", function() { /* 绑定所有表单设计区的点击事件*/
            var fieldAlert = $(this).attr("fieldAlert");
            if (fieldAlert != "" && fieldAlert != null) {
                layer.tips(fieldAlert, $(this), {
                    tips: [1, '#0FA6D8'], /* 还可配置颜色*/
                    time: 4000
                });
            }
        });
    },
    windowResize:function(){/*初始化窗口变化事件*/
    	$(window).resize(function() {
      	  console.log("---------");
      	});
    },
    editWidget_: function(o) {/*控件编辑*/
        var thi_ = $($(o).closest('.grid-stack-item'));
        var designType = thi_.attr('data-gs-design-type');/*控件类型*/
        var designDataObj = new Object();
        $(".profile-user-info").removeClass("select");
        $(thi_).find(".profile-user-info").addClass("select");
        if (thi_.find(".dropdiv").length > 0) { /* 表字段*/
            $.each($.Fields, function(index, val) {
                designDataObj[val.id] = thi_.find(".dropdiv").attr("design-" + val.id)=="null"?"":thi_.find(".dropdiv").attr("design-" + val.id);
                /* console.log(thi_.find(".dropdiv").attr("design-"+val));*/
               var  fieldShowType_=val.fieldShowType;
               /*如果定义了readonly则不允许编辑，只能查看*/
               $.Fields[index].sType = (val.sType=="readonly")?"readonly":"hidden";
               if(fieldShowType_.length>0){
            	   var index1_ = $.inArray(designType,fieldShowType_);
            	   if(fieldShowType_.length==1&&fieldShowType_[0]=="*"){
                   	$.Fields[index].sType = (val.sType=="readonly")?"readonly":"show";
                   }
            	   else if(index1_!=-1){
                   	$.Fields[index].sType = (val.sType=="readonly")?"readonly":"show";
                   }
               }
            });
            
            var getTpl = document.getElementById('Tdemo').innerHTML;
            laytpl(getTpl).render($.Fields, function(html) {
                document.getElementById('FieldSetTable').innerHTML = html;
            });
            layui_element.tabChange('docDemoTabBrief', "FieldSet");
            $.designSet(designDataObj);
        }
        /*
         * else if (thi_.find("[label-module]").length > 0) {// 标题
         * $.each($.Fields, function(index, val) { designDataObj[val.id] =
         * thi_.find("[label-module]").attr( "design-" + val.id); }); var getTpl =
         * document.getElementById('Tdemo').innerHTML;
         * laytpl(getTpl).render($.Fields, function(html) {
         * document.getElementById('FieldSetTable').innerHTML = html; });
         * layui_element.tabChange('docDemoTabBrief', "FieldSet");
         * designSet(designDataObj); }
         */
        $.designBinding();
    },
    designSet: function(designObj) {
        $.each($.Fields, function(index, val) {
            try {
                $("#formobj_1_").find("#FieldSetTable").find("#" + val.id).val(designObj[val.id]);
                $("body").attr("onbeforeUnload","return '';");
            } catch (e) {}
        });
    },
    designSetTitle: function(designObj) {
        $.each($.Titles, function(index, val) {
            try {
                $("#formobj_1_").find("#FieldSetTable").find("#" + val.id).val(designObj[val.id]);
                $("body").attr("onbeforeUnload","return '';");
            } catch (e) {}
        });
    },
    getFromMap: function(fromId){
    	var disabledStr=$("#"+fromId).find("[disabled]");
    	disabledStr.each(function(index,item) {$(item).attr("disabled",false);});
    	var jsonData = $("#"+fromId).serializeArray();
    	disabledStr.each(function(index,item) {$(item).attr("disabled",true);});
    	var fromMap={};
    	var fromFieldNmae = "";
    	$.map(jsonData, function (item) {
    		var iname=item.name;
    			var has = item.name in fromMap;
        		var mapValue=item.value;
        		if(has){
        			var value = fromMap[iname];
        			mapValue=mapValue+","+value
        		}
        		if(!has){
        			fromFieldNmae=fromFieldNmae+","+iname;
        		}
        		fromMap[iname] = mapValue;
    	});
    	/*console.log(fromMap);*/
    	return fromMap;
    },
     saveData:function(isRefresh) {
		if(!myValidform.check()){
			return false;
		}
		var validIdLen=0;
		try{
			validIdLen=$("#"+$.businessCode+"\\@id").length;
		}catch(e){
			
		}
		if(validIdLen==0){
			layer.msg("业务表单主键未配置，不能保存",{icon: 5});
			return false;
		}
		
		layer.load();
		var fromMap=$.getFromMap("mainPageForm");
		$.ajax({
			async : false,
			cache : false,
			type : "POST",
			url : "editPageGenController.do?doSaveOrUpdateData&releaseCode="+$.releaseCode+"&versionNum="+$.versionNum+"&bussTemplateId="+$.bussTemplateId+"&refDataid="+$.mainId+"&refBusscode="+$.businessCode,/* 请求的action路径*/
			data:fromMap,
			error : function() {/* 请求失败处理函数*/
			layer.msg('保存失败',{icon: 4});
			layer.closeAll('loading');
			},
			success : function(data) {
				var data0=data;/*eval("("+data+")");*/
				
				if(data0.success==true){
					$.mainId=data0.obj;
					try{$("[id='"+$.businessCode+"@id']").val($.mainId);}catch(e){layer.msg("未配置业务主键在表单中",{icon: 4});}
					try{window.opener.layuiTableReload($.releaseCode,{});}catch(e){}
					if(isRefresh){
						window.location.href="aceAutoController.do?modePage&type=page&releaseCode="+$.releaseCode+"&bussCode="+$.businessCode+"&mainId="+$.mainId+"";
					}
				}else{
					layer.msg(data0.msg,{icon: 4});
				}
				layer.closeAll('loading');
				$('#gritter-notice-wrapper').remove(); 
			}
		});
	},
	 setProcessVar:function(varobj,fromId,varMap_) {
		 var varMap={};
		 var keys = "", values ="", types = "";
		 $("#"+fromId).find(varobj).each(function(index,item) {
			var iname=item.name;
			iname=iname.replace($.businessCode+"_","");/*替换前缀*/
			var mapValue=item.value;
    		
    		if(iname=="LINE"){
				var mapValues= mapValue.split(";");/*当判定条件有多个时需要才能够配置的值中逐个对比。*/
				if(mapValues.length>1){/*根据规则判断走哪一条路线*/
					var map2json=JSON.stringify(varMap_);
					$.getJSON("processRestController.do?validationRules&vStrng="+mapValue+"&varMap="+map2json+"",function(resultData) {
						mapValue=resultData.res;
					});
				}
			}
    		varMap[iname] = mapValue;
    		if($(item).attr("processvar")!=""){
				keys += iname+ ",";
				values+= mapValue + ",";
				types += $(item).attr("processvar") + ",";
    		}
		});
		 $("#designMainGrid_show,#designMainGrid_hide").find("[isprocessvariables]").each(function(index,item) {
				var iname=item.name;
				iname=iname.replace($.businessCode+"@","");/*替换前缀*/
				var mapValue=item.value;
				   if($(item).attr("type")=="radio"||$(item).attr("type")=="checkbox"){
					   mapValue=$("[name='"+$(item).attr("name")+"']:checked").val();
					}
				   var has = iname in varMap;
				   if(!has){
	        			varMap[iname] = mapValue;
	        			if($(item).attr("isprocessvariables")!=""){
	    					keys += iname+ ",";
	    					values+= mapValue + ",";
	    					types += $(item).attr("isprocessvariables") + ",";
	    	    		}
	        		}
				   
	    		
			});
		$("#"+fromId).find("#"+$.businessCode+"_pKeys").val(keys);
 		$("#"+fromId).find("#"+$.businessCode+"_pValues").val(values);
 		$("#"+fromId).find("#"+$.businessCode+"_pTypes").val(types);
 		varMap["pKeys"] = keys;
 		varMap["pValues"] = values;
 		varMap["pTypes"] = types;
		return varMap;
	},
	submitBusiness:function() {
		
		var varMap={};
		
		$("#mainPageForm").find("[processvar]").each(function(index,item) {
			var iname=item.name;
			iname=iname.replace($.businessCode+"_","");/*替换前缀*/
			var mapValue=item.value;
    		if($(item).attr("processvar")!=""){
				varMap[iname] = item.value;
    		}
		});
		/*获取当前页面中的流程变量*/
		$("#designMainGrid_show,#designMainGrid_hide").find("[isprocessvariables]").each(function(index,item) {
			   if($(item).attr("isprocessvariables")!=""){
				   var iname=item.name;
					iname=iname.replace($.businessCode+"@","");/*替换前缀*/
					var mapValue=item.value;
					   if($(item).attr("type")=="radio"||$(item).attr("type")=="checkbox"){
						   mapValue=$("[name='"+$(item).attr("name")+"']:checked").val();
						}
					   var has = iname in varMap;
					   if(!has){
						   if($(item).attr("isprocessvariables")!=""){
								varMap[iname] = mapValue;
				    		}
					   }
			   }
		   });
		
		var tipMsg1 =$("#mainPageForm").find("#"+$.businessCode+"_tipMsg1").val();
		var tipMsg1_1= tipMsg1.split(";");
		var isb_=true;
		if(tipMsg1_1.length>1){
			var t1="";
			for(var i1=0;i1<tipMsg1_1.length;i1++){
				var mapValues1= tipMsg1_1[i1].split("\>");
				if(mapValues1.length<1){
					isb_=false;
					layer.msg('分支参数配置错误，请参照KExpressionV2.0规则配置！',{icon: 4});
				}
			}
			var map2json=JSON.stringify(varMap);
			$.ajax({
				async : false,
				cache : false,
				type : "POST",
				url : "processRestController.do?validationRules&vStrng="+tipMsg1+"&varMap="+map2json+"",/* 请求的action路径*/
				error : function() {/* 请求失败处理函数*/
					layer.msg('验证失败',{icon: 4});
					layer.closeAll('loading');
				},
				success : function(data) {
					var data0=eval("("+data+")");
					tipMsg1=data0.res;
					if(data0.mag=="0"){
						isb_=false;
						layer.msg(data0.res,{icon: 4});
					}
				}
				});
		}
		if(!isb_){return false;}
		
		myConfirmDialog("您确定要发送"+tipMsg1+"吗？", function() {
			layer.load();
			var processvarMap=$.setProcessVar("[processvar]", "mainPageForm",varMap);
			$.ajax({
				async : true,
				cache : false,
				type : "POST",
				url : "editPageGenController.do?submitBusiness",/* 请求的action路径*/
				data:processvarMap,
				error : function() {/* 请求失败处理函数*/
					layer.msg('发送失败',{icon: 4});
					layer.closeAll('loading');
				},
				success : function(data) {
					var data0=data;/*eval("("+data+")");*/
					try{eval("window.opener."+$.businessCode+"_doQuery()");}catch(e){}/*刷新父页面*/
					if(data0.complete){
						parent.layer.alert(data0.msg, {
							 closeBtn: 0
							}, function(index, layero){
								parent.layer.close(index);
								try{
									parent.window.close();
									}catch(e){
									window.close();
								}
							});
					}else{
						layer.msg(data0.msg,{icon: 4});
					}
					 
					layer.closeAll('loading');
				}
			});
		}, function() {
			return true;
		},"");
		},
	getDictDataHtml:function(designId,selectid,fieldhref) {
		var htmltmp;
		if(selectid==""){
			return false;
		}
		if(fieldhref==""){
			return false;
		}
		$.ajax({
			async : false,
		    type: "POST",
		    url: "designController.do?getDictDataHtml",
		    data:{design_id:designId,selectid:selectid,fieldhref:fieldhref},
		    success: function(data) {
		    	var dictDataList_ = data.dictDataList;
		    	htmltmp=eval("("+dictDataList_+")");
		    	/*console.log("---------------------return dictDataList htmltmp--"+htmltmp);*/
		    },
		    error: function(data) {
		    	console.log(data.responseText);
		    	alert("数据源编码为：“"+fieldhref+"” 加载失败！");
		    }
		});
		return htmltmp;
	},
	 getProcessNodeAction: function() {
		try{
			/*var taskId="";
			if(mainId!=null&&mainId!=""){
	    		var procinstid=$.getProcessIdByBusKey(mainId);
	    		if(procinstid==""){
	    			procinstid=$.startProcess(bussCode,mainId);
	    		}
	    		if(taskIdOld!=null&&taskIdOld!=""){
					taskId=taskIdOld;
				}else{
					taskId=$.getTaskByPrcIdAndUserCode(procinstid);
				}
	    		$.getProcessAction($.taskId,$.mainId);
			  }*/
	  	}catch(e){
	  	}
	},
	 getTaskByPrcIdAndUserCode:function(procInstId) {
		var taskId="";
		$.ajax({
			async : false,
			cache : false,
			type : "GET",
			url : "processRestController.do?getTaskByPrcIdAndUserCode",/* 请求的action路径*/
			data:"PROCINSTID="+procInstId+"&MUNITID=&APPID=&USERCODE=",
			error : function() {/* 请求失败处理函数*/
			},
			success : function(data) {
				var data0=eval("("+data+")");
				/*console.log("getTaskByPrcIdAndUserCode");*/
				/*console.log(data0);*/
				if(data0.success=="true"){
					taskId=data0.taskids[0].taskid;
				}
			}
		});
		return taskId;
	},
	 startProcess:function(bussCode,mainId) {
		  var procInstId="";
			var timestamp = Date.parse(new Date());
			$.ajax({
				async : false,
				cache : false,
				type : "POST",
				url : "processRestController.do?startProcessInstanceByKey",/* 请求的action路径*/
				data:"BUSSCODE="+bussCode +
					 "&BUSKEY="+mainId +
					 "&BUSINESS_KEY="+mainId +
					 "&USERID="+
					 "&MUNITID="+
					 "&APPID="+
					 "&PROCESSKEY="+
					 "&PROCESS_DEFINITION_KEY="+
					 "&INITIATOR="+
					 "&TITIE=" +
					 "&TYPE="+
					 "&SYSTEM="+
					 "&URL="+
					 "&SERIAL_NUMBER="+timestamp,
				error : function() {/* 请求失败处理函数*/
				},
				success : function(data) {
					var data0=eval("("+data+")");
					/*console.log("startProcess");*/
					/*console.log(data0);*/
					procInstId=data0.PROCESSINSTANCEID;
				}
			});
			return procInstId;
		},
	 getProcessIdByBusKey :function(mainId) {
		var procinstid="";
		$.ajax({
			async : false,
			cache : false,
			type : "GET",
			url : "processRestController.do?getProcessIdByBusKey",/* 请求的action路径*/
			data:"BUSKEY="+mainId,
			error : function() {/* 请求失败处理函数*/
			},
			success : function(data) {
				var data0=eval("("+data+")");
				/*console.log("getProcessIdByBusKey");*/
				if(data0.SUCCESS=="true"){
					procinstid=data0.PROCINSTIDS[0].PROCINSTID;
				}else{
					procinstid="";
				}
			}
		});
		return procinstid;
	},
	 openActionWindow :function(ths) {
		var taskId=$(ths).attr("taskId"),
 		nodeActionId=$(ths).attr("nodeActionId"),
 		nodeId=$(ths).attr("nodeId"),
 		line=$(ths).attr("line"),
 		tipMsg1=$(ths).attr("tipMsg1"),
 		tipMsg2=$(ths).attr("tipMsg2"),
 		actionParam=$(ths).attr("actionParam"),
 		processId=$(ths).attr("processId"),
 		versionNum=$(ths).attr("versionNum"),
 		actionName=$(ths).attr("actionName"), 
 		bussTemplateId=$(ths).attr("templateId"),
 		buskey=$(ths).attr("mainId"),
 		width_=$(ths).attr("openWidth"),
 		height_=$(ths).attr("openHeight");
		 
    	var width = width_!=null&&width_!=""&&width_!="null"?width_:700;
    	var height = height_!=null&&height_!=""&&height_!="null"?height_:400;
    	if(width.toString().indexOf("%")!=-1){
    		width = document.body.offsetWidth*(parseFloat(width)/100);
    	}
    	if(height.toString().indexOf("%")!=-1){
    		height =document.body.offsetHeight*(parseFloat(height)/100)-100;
    		
    	}
    	height=parseFloat(height)+80;
    	parent.layer.open({
    		   type: 2,
    		   title: actionName,
    		   maxmin: true,
    		   shadeClose: false, /*点击遮罩关闭层*/
    		   area : [width+'px' , height+'px'],
    		   success: function(layero, index){
    			   var iframe_= $(layero).find("iframe")[0].contentWindow;
    			  var form1= parent.layer.getChildFrame('form', index);
    			   var bCode=iframe_.$.businessCode;/*获取子页面的业务编码*/
    			   var versionNum=iframe_.$.versionNum;/*获取子页面*/
    			   var mainId=iframe_.$.mainId;/*获取子页面的*/
    			   var bussTemplateId=iframe_.$.bussTemplateId;/*获取子页面的*/
    			   iframe_.$.taskId=taskId;/*给子页面赋值任务id，只能从这个地方传入，不然影响数据获取*/
    			   
    			   
    			   var disabledStr=$("#mainPageForm").find("[disabled]");
    		       disabledStr.each(function(index,item) {$(item).attr("disabled",false);});
    			   var processHtml='<!------流程相关参数-----start---> ';
    			   processHtml+='<div id=processvar>';
    			   /*获取当前页面中流程配置属性的信息作为流程变量存储在数据库中*/
    			   $("#designMainGrid_show,#designMainGrid_hide").find("[isprocessvariables]").each(function(index,item) {
    				   if($(item).attr("isprocessvariables")!=""){
    					   var v1=$(item).val();
    					   if($(item).attr("type")=="radio"||$(item).attr("type")=="checkbox"){
    							v1=$("[name='"+$(item).attr("name")+"']:checked").val();
    						}
    					   processHtml+='<input  processvar="'+$(item).attr("isprocessvariables")+'" type="hidden" id="'+bCode+'_'+($(item).attr("name").replace($.businessCode+"@",""))+'" name="'+bCode+'_'+($(item).attr("id").replace($.businessCode+"@",""))+'"  value="'+v1+'" />  ';
    				   }
    			   });
    			   disabledStr.each(function(index,item) {$(item).attr("disabled",true);});
    			   
			   		
			   		  processHtml+='<input  processvar="" name="'+bCode+'_pKeys" id="'+bCode+'_pKeys" type="hidden" />';
			   		  processHtml+='<input  processvar=""  name="'+bCode+'_pValues" id="'+bCode+'_pValues" type="hidden" />';
		   			  processHtml+='<input  processvar=""  name="'+bCode+'_pTypes" id="'+bCode+'_pTypes" type="hidden" />';
    				  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_taskId" name="'+bCode+'_taskId" value="'+taskId+'"/> ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_nodeId" name="'+bCode+'_nodeId" value="'+nodeId+'" />  ';
	    			  processHtml+='<input  processvar="S" type="hidden" id="'+bCode+'_LINE" name="'+bCode+'_LINE"  value=\''+line+'\' />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_tipMsg1" name="'+bCode+'_tipMsg1" value=\''+tipMsg1+'\' />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_tipMsg2" name="'+bCode+'_tipMsg2" value=\''+tipMsg2+'\' />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_actionParam" name="'+bCode+'_actionParam" value="'+actionParam+'" />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_processId" name="'+bCode+'_processId" value="'+processId+'" />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_mainId" name="'+bCode+'_mainId" value="'+mainId+'" />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_bussTemplateId" name="'+bCode+'_bussTemplateId" value="'+bussTemplateId+'" />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_versionNum" name="'+bCode+'_versionNum" value="'+versionNum+'" />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_bussCode" name="'+bCode+'_bussCode" value="'+bCode+'" />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_refBusscode" name="'+bCode+'_refBusscode" value="'+$.businessCode+'" />  ';
	    			  processHtml+='<input  processvar="" type="hidden" id="'+bCode+'_nodeActionId" name="'+bCode+'_nodeActionId" value="'+nodeActionId+'" />  ';
	    			  processHtml+='</div>';
	    			  processHtml+='<!------流程相关参数----end---->';
	    			  $(form1).append(processHtml);
	    			  
    		   },
    		   content: "aceAutoController.do?modePage&type=page&releaseCode="+$.releaseCode+"&versionNum="+versionNum+"&bussTemplateId="+ bussTemplateId
									+ "&bussCode=&mainId="+buskey+"",
    		   	cancel: function(){}
    		});
    	/*parent.layer.iframeAuto(index);*/
    	
    },
	 getProcessAction: function(taskId,mainId) {
		  $.ajax({
				async : false,
				cache : false,
				type : "GET",
				url : "processRestController.do?getProcessNodeAction",/* 请求的action路径*/
				data:"MUNITID=&APPID=&TASKID="+taskId,
				error : function() {/* 请求失败处理函数*/
				},
				success : function(data) {
					var data0=eval("("+data+")");
					if(data0.success=="true"){
						/*console.log("getProcessNodeAction");*/
						/*console.log(data0);*/
						var thml11="";
						$(data0.nodeActionData).each(function(i,val) {
							thml11+="<div class=\"layui-btn layui-btn-normal\" " +
							" taskId='"+taskId+"'" +
							" nodeActionId='"+val.nodeActionId+"'" +
							" nodeId='"+val.nodeId+"'" +
							" line='"+val.line+"'" +
							" tipMsg1='"+val.tipMsg1+"'" +
							" tipMsg2='"+val.tipMsg2+"'" +
							" actionParam='"+val.actionParam+"'" +
							" processId='"+val.processId+"'" +
							" version='"+val.version+"'" +
							" actionName='"+val.actionName+"'" +
							" templateId='"+val.templateId+"'" +
							" mainId='"+mainId+"'" +
							" openWidth='"+val.openWidth+"'" +
							" openHeight='"+val.openHeight+"'" +
							" onclick=\"$.openActionWindow(this)\">"+val.actionName+"</div> ";
							proceFunc = true;
						});
						thml11+="<div style='margin-top: 8px;border-bottom: 2px solid #48a1e4;'></div>";
						$("#processNodeActionBtn").html(thml11);
						$("#processNodeActionBtn").addClass("action_btn");
						$("#mainGrid_").removeClass("mainbody");
					}
				}
			});
	  }
	
});

