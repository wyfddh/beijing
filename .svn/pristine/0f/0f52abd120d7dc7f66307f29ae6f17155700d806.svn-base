<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tj720.admin.dao.map.GovNoticeOrgMapper" >
  <resultMap id="BaseResultMap" type="com.tj720.admin.model.GovNoticeOrg" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    <id column="id" property="id" jdbcType="VARCHAR" />
    <result column="notice_id" property="noticeId" jdbcType="VARCHAR" />
    <result column="org_id" property="orgId" jdbcType="VARCHAR" />
    <result column="receive_status" property="receiveStatus" jdbcType="VARCHAR" />
    <result column="look_time" property="lookTime" jdbcType="TIMESTAMP" />
    <result column="write_time" property="writeTime" jdbcType="TIMESTAMP" />
    <result column="receiver" property="receiver" jdbcType="VARCHAR" />
    <result column="reportId" property="reportId" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    id, notice_id, org_id, receive_status, look_time, write_time, receiver,reportId
  </sql>
  <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.tj720.admin.model.GovNoticeOrgExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from gov_notice_org
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    select 
    <include refid="Base_Column_List" />
    from gov_notice_org
    where id = #{id,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    delete from gov_notice_org
    where id = #{id,jdbcType=VARCHAR}
  </delete>
  <delete id="deleteByExample" parameterType="com.tj720.admin.model.GovNoticeOrgExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    delete from gov_notice_org
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.tj720.admin.model.GovNoticeOrg" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    insert into gov_notice_org (id, notice_id, org_id, 
      receive_status, look_time, write_time, 
      receiver,reportId)
    values (#{id,jdbcType=VARCHAR}, #{noticeId,jdbcType=VARCHAR}, #{orgId,jdbcType=VARCHAR}, 
      #{receiveStatus,jdbcType=VARCHAR}, #{lookTime,jdbcType=TIMESTAMP}, #{writeTime,jdbcType=TIMESTAMP}, 
      #{receiver,jdbcType=VARCHAR}, #{reportId,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.tj720.admin.model.GovNoticeOrg" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    insert into gov_notice_org
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="noticeId != null" >
        notice_id,
      </if>
      <if test="orgId != null" >
        org_id,
      </if>
      <if test="receiveStatus != null" >
        receive_status,
      </if>
      <if test="lookTime != null" >
        look_time,
      </if>
      <if test="writeTime != null" >
        write_time,
      </if>
      <if test="receiver != null" >
        receiver,
      </if>
       <if test="reportId != null" >
        reportId,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="noticeId != null" >
        #{noticeId,jdbcType=VARCHAR},
      </if>
      <if test="orgId != null" >
        #{orgId,jdbcType=VARCHAR},
      </if>
      <if test="receiveStatus != null" >
        #{receiveStatus,jdbcType=VARCHAR},
      </if>
      <if test="lookTime != null" >
        #{lookTime,jdbcType=TIMESTAMP},
      </if>
      <if test="writeTime != null" >
        #{writeTime,jdbcType=TIMESTAMP},
      </if>
      <if test="receiver != null" >
        #{receiver,jdbcType=VARCHAR},
      </if>
      <if test="reportId != null" >
        #{reportId,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.tj720.admin.model.GovNoticeOrgExample" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    select count(*) from gov_notice_org
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    update gov_notice_org
    <set >
      <if test="record.id != null" >
        id = #{record.id,jdbcType=VARCHAR},
      </if>
      <if test="record.noticeId != null" >
        notice_id = #{record.noticeId,jdbcType=VARCHAR},
      </if>
      <if test="record.orgId != null" >
        org_id = #{record.orgId,jdbcType=VARCHAR},
      </if>
      <if test="record.receiveStatus != null" >
        receive_status = #{record.receiveStatus,jdbcType=VARCHAR},
      </if>
      <if test="record.lookTime != null" >
        look_time = #{record.lookTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.writeTime != null" >
        write_time = #{record.writeTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.receiver != null" >
        receiver = #{record.receiver,jdbcType=VARCHAR},
      </if>
      <if test="record.reportId != null" >
        reportId = #{record.reportId,jdbcType=VARCHAR},
      </if>
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    update gov_notice_org
    set id = #{record.id,jdbcType=VARCHAR},
      notice_id = #{record.noticeId,jdbcType=VARCHAR},
      org_id = #{record.orgId,jdbcType=VARCHAR},
      receive_status = #{record.receiveStatus,jdbcType=VARCHAR},
      look_time = #{record.lookTime,jdbcType=TIMESTAMP},
      write_time = #{record.writeTime,jdbcType=TIMESTAMP},
      receiver = #{record.receiver,jdbcType=VARCHAR},
      reportId = #{record.reportId,jdbcType=VARCHAR}
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.tj720.admin.model.GovNoticeOrg" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    update gov_notice_org
    <set >
      <if test="noticeId != null" >
        notice_id = #{noticeId,jdbcType=VARCHAR},
      </if>
      <if test="orgId != null" >
        org_id = #{orgId,jdbcType=VARCHAR},
      </if>
      <if test="receiveStatus != null" >
        receive_status = #{receiveStatus,jdbcType=VARCHAR},
      </if>
      <if test="lookTime != null" >
        look_time = #{lookTime,jdbcType=TIMESTAMP},
      </if>
      <if test="writeTime != null" >
        write_time = #{writeTime,jdbcType=TIMESTAMP},
      </if>
      <if test="receiver != null" >
        receiver = #{receiver,jdbcType=VARCHAR},
      </if>
      <if test="reportId != null" >
        reportId = #{reportId,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.tj720.admin.model.GovNoticeOrg" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 02 15:29:53 CST 2018.
    -->
    update gov_notice_org
    set notice_id = #{noticeId,jdbcType=VARCHAR},
      org_id = #{orgId,jdbcType=VARCHAR},
      receive_status = #{receiveStatus,jdbcType=VARCHAR},
      look_time = #{lookTime,jdbcType=TIMESTAMP},
      write_time = #{writeTime,jdbcType=TIMESTAMP},
      receiver = #{receiver,jdbcType=VARCHAR},
      reportId = #{reportId,jdbcType=VARCHAR}
    where id = #{id,jdbcType=VARCHAR}
  </update>
  
  <resultMap id="ReceiveNoticeMap" type="com.tj720.admin.dto.ReceiveNoticeDto" >      
  </resultMap>
   <resultMap id="UserMap" type="com.tj720.admin.dto.MipUserDto" >      
  </resultMap>
   <resultMap id="ReceiveNoticeDetailMap" type="com.tj720.admin.dto.ReceiveNoticeDetailDto" >      
  </resultMap>
  
   <select id="getList" resultMap="ReceiveNoticeMap" >    
    select gno.id as id, gno.org_id as orgId, gno.notice_id as noticeId, gno.receive_status as receiveStatus, gno.look_time as lookTime, gno.write_time as writeTime,
     mu.name as receiver,gn.title as title, gn.lastUpdate_time as lastUpdateTime, gn.isFeedBack as isFeedBack, gn.deadline_time as deadlineTime, mo.name as publishOrg 
    from gov_notice_org gno 
    left join gov_notice gn on gno.notice_id = gn.id
    left join mip_user mu on gno.receiver = mu.id
    left join mip_organization mo on mo.id = gn.publishOrg
    where  gn.publish_status != -1 and gno.receive_status != -1
    <if test="userOrg != null">
		and gno.org_id = #{userOrg} 
	</if>
     <if test="userId != null">
		and gno.receiver = #{userId} 
	</if>
    <if test="key != null">
		and gn.title like '%${key}%' 
	</if>
	<if test="startTime!=null">
   	 	and gn.lastUpdate_time  &gt; '${startTime}'
    </if>
     <if test="endTime!=null">
    	and gn.lastUpdate_time &lt; '${endTime}'
     </if>
	<if test="isFeedBack != null and isFeedBack !=''">
		and gn.isFeedBack = #{isFeedBack}
	</if>
	<if test="publishOrg != null  and publishOrg !=''">
		and gn.publishOrg = #{publishOrg}
	</if>
	<if test="receiveStatus != null  and receiveStatus !=''">
		and gno.receive_status = #{receiveStatus}
	</if>
	ORDER BY gn.lastUpdate_time desc
	<if test=" startRow == -1">
		limit #{pageSize}
	</if>
	<if test=" startRow != -1">
		limit #{startRow},#{pageSize}
	</if>
	
  </select>
  <select id="countList" resultType="java.lang.Integer" >    
    select count(*)
    from gov_notice_org gno 
    left join gov_notice gn on gno.notice_id = gn.id
    left join mip_user mu1 on gno.receiver = mu1.id
    left join mip_organization mo on mo.id = gn.publishOrg
    where gn.publish_status !=  -1 and gno.receive_status !=  -1
    <if test="userOrg != null">
		and gno.org_id = #{userOrg} 
	</if>
     <if test="userId != null">
		and gno.receiver = #{userId} 
	</if>
    <if test="key != null">
		and gn.title like '%${key}%' 
	</if>
	<if test="startTime!=null">
   	 	and gn.lastUpdate_time  &gt; '${startTime}'
    </if>
     <if test="endTime!=null">
    	and gn.lastUpdate_time &lt; '${endTime}'
     </if>
	<if test="isFeedBack != null and isFeedBack !=''">
		and gn.isFeedBack = #{isFeedBack}
	</if>
	<if test="publishOrg != null  and publishOrg !=''">
		and gn.publishOrg = #{publishOrg}
	</if>
	<if test="receiveStatus != null  and receiveStatus !=''">
		and gno.receive_status = #{receiveStatus}
	</if>
  </select>
  
  <select id="getUsers" resultMap="UserMap" >    
   select distinct mu.* from mip_user mu
   left join mip_user_role mur on mur.user_id = mu.id
   where 1=1 and mu.status=1 and mur.status=1
    <if test="userOrg != null">
		and mu.org_id = #{userOrg} 
	</if>
    <if test="role != null">
		and mur.role_id = #{role} 
	</if>  
  </select>
  
  <select id="getReceiverByOrgids" resultType="java.lang.String" >    
   SELECT
	   distinct b.user_id as userId
	FROM
	  mip_organization a, mip_user_role b
	WHERE
		1 = 1
	AND a. STATUS = 1
	AND b. STATUS = 1
	and a.shortname = b.role_id
	and EXISTS(select a.id from mip_user c where c.id=b.user_id and c.org_id=a.id and c.status = '1')
	and a.id in
	     <foreach collection="list" item="item" open="(" close=")" separator=",">
	       	#{item,jdbcType=VARCHAR}
	     </foreach>
  </select>
  
  <select id="getForwardByOrgids" resultType="java.lang.String" >    
   SELECT
	   receiver
	FROM
	  gov_notice_org a
	WHERE
		1 = 1
	<![CDATA[ AND a.receive_status <> '-1' ]]> 
	and a.notice_id = #{noticeId}
	and a.receiver is not null
	<![CDATA[ and a.receiver <> ''  ]]> 
	and a.org_id in
	     <foreach collection="list" item="item" open="(" close=")" separator=",">
	       	#{item,jdbcType=VARCHAR}
	     </foreach>
  </select>
  
  <insert id="insertByBatch" parameterType="java.util.List">
       insert into gov_notice_org
       values
       <foreach collection="list" item="item" index="index" separator=",">
           (
           	#{item.id,jdbcType=VARCHAR}, 
           	#{item.noticeId,jdbcType=VARCHAR},
           	#{item.orgId,jdbcType=VARCHAR},
           	#{item.receiveStatus,jdbcType=VARCHAR},
           	#{item.lookTime,jdbcType=TIMESTAMP},
           	#{item.writeTime,jdbcType=TIMESTAMP},
           	#{item.receiver,jdbcType=VARCHAR},
           	NULL
           )
       </foreach>
   </insert>

  <update id="changeStatus">
    update gov_notice_org
    set receive_status = #{receiveStatus,jdbcType=VARCHAR}
    <if test="viewTime != null">
		, look_time = #{viewTime,jdbcType=TIMESTAMP} 
	</if>
	<if test="writeTime != null">
		, write_time = #{writeTime,jdbcType=TIMESTAMP} 
	</if>
	<if test="reportId != null and reportId != ''">
		, reportId = #{reportId,jdbcType=VARCHAR} 
	</if>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <update id="changeReceiver">
    update gov_notice_org
    set receiver = #{receiver,jdbcType=VARCHAR}
    where id = #{id,jdbcType=VARCHAR}
  </update>

<select id="getDetail" resultMap="ReceiveNoticeDetailMap" >    
   select gn.id as id,gn.title as title,gn.content as content,gn.lastUpdate_time as lastupdateTime,gn.isFeedBack as isfeedback,gn.attachment_ids as attachmentIds,
   gn.deadline_time as deadlineTime ,gn.isFill as isfill,gn.reportCode as reportCode,mo.name as publishOrgName,  gno.id  as detailId,gno.receive_status as receiveStatus,
   gno.reportId
   from gov_notice gn
   left join gov_notice_org gno on gn.id= gno.notice_id
   left join mip_organization mo on mo.id = gn.publishOrg
   where 1=1 
    <if test="_parameter != null">
		and gno.id = #{_parameter,jdbcType=VARCHAR} 
	</if>
  </select>
  
<select id="getViewStatic" parameterType="java.util.List" resultType="java.util.Map">
   select a.notice_id, count(a.id) as sum, 
			 sum(if(a.receive_status in('1', '2', '4', '5'),1,0)) as loolNum,
			 sum(if(a.receive_status = '4',1,0)) as writeNum
	from gov_notice_org a
	left join mip_organization b on(a.org_id = b.id)
	where 1=1
	and b.status = '1'
	<if test="list != null">
	and a.notice_id in
	    <foreach collection="list" item="item" open="(" close=")" separator=",">
	       	#{item,jdbcType=VARCHAR}
	     </foreach>
	</if>
     group by a.notice_id
  </select>
  
<select id="selectReceiveConditionList" resultMap="ReceiveNoticeMap">
   select a.id as id, a.org_id as orgId, a.notice_id as noticeId, a.receive_status as receiveStatus, a.look_time as lookTime, a.write_time as writeTime,mo.name as receiveOrgName,
   c.reportCode as reportCode, d.buss_code as bussCode, a.reportId
	from gov_notice_org a
   	left join mip_organization mo on mo.id = a.org_id
   	left join gov_notice c on(c.id=a.notice_id)
   	left join cgform_buss d on(c.reportCode=d.id)
	where 1=1
	and a.notice_id = #{noticeId, jdbcType=VARCHAR}
	and mo.status = '1'
	<if test="key != null and key != ''">
		and mo.name like '%${key}%'
	</if>
	<if test="lookStatus != null and lookStatus != ''">
		<if test="lookStatus == 0">
			and a.receive_status = '0' 
		</if>
		<if test="lookStatus == 1">
			<![CDATA[ and a.receive_status <> '0'   ]]> 
		</if>
	</if>
	<if test="writeStatus != null and writeStatus != ''">
		<if test="writeStatus == 0">
			and a.receive_status in('0', '1')
		</if>
		<if test="writeStatus == 1">
			and a.receive_status = '2'
		</if>
		<if test="writeStatus == 2">
			and a.receive_status = '4'
		</if>
	</if>
	ORDER BY mo.name
	<if test=" startRow == -1">
		limit #{pageSize}
	</if>
	<if test=" startRow != -1">
		limit #{startRow},#{pageSize}
	</if>
  </select>
  
<select id="countReceiveConditionList" resultType="java.lang.Integer">
   select count(*)
	from gov_notice_org a
   	left join mip_organization mo on mo.id = a.org_id
	where 1=1
	and a.notice_id = #{noticeId, jdbcType=VARCHAR}
	and mo.status = '1'
	<if test="key != null and key != ''">
		and mo.name like '%${key}%'
	</if>
	<if test="lookStatus != null and lookStatus != ''">
		<if test="lookStatus == '0'">
			and a.receive_status = '0' 
		</if>
		<if test="lookStatus == '1'">
			<![CDATA[ and a.receive_status <> '0'   ]]> 
		</if>
	</if>
	<if test="writeStatus != null and writeStatus != ''">
		<if test="writeStatus == '0'">
			and a.receive_status in('0', '1')
		</if>
		<if test="writeStatus == '1'">
			and a.receive_status = '2'
		</if>
		<if test="writeStatus == '2'">
			and a.receive_status = '4'
		</if>
	</if>
  </select>
  <!-- 查博物馆前4条通知公告 -->
  <select id="getNoticeListForDesk" resultMap="ReceiveNoticeMap" > 
	select gnr.id,
		gn.title,
		gn.lastUpdate_time as "lastUpdateTime",
		gn.isFeedBack,
		gn.deadline_time as "deadlineTime", 
		gn.isFill,
		gnr.receive_status as "receiveStatus",
		gn.reportCode,
		mo.name as "publishOrg"
		from gov_notice gn,gov_notice_org gnr,mip_organization mo
		where gn.id=gnr.notice_id
		and gn.publishOrg = mo.id
		and gn.publish_status='2'
		and gnr.receive_status in('0','1','2','4','5')
		and gnr.org_id = #{orgId}
	ORDER BY gn.lastUpdate_time desc
	limit 4
  </select>
  <select id="getListByNoticeId" resultType="com.tj720.admin.model.GovNoticeOrg" > 
	select a.id, a.notice_id as  noticeId, a.org_id as  orgId, a.receive_status as  receiveStatus,
	a.look_time as  lookTime,a.write_time as  writeTime,a.receiver,a.reportId
	from gov_notice_org a, mip_organization b
	where 1=1
	and a.org_id=b.id
	and a.notice_id = #{noticeId}
	and b.status = '1'
	and b.parent_id is not null
	<![CDATA[ and a.receive_status <> '-1' ]]> 
  </select>
</mapper>