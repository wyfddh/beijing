<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tj720.admin.dao.map.MipTopicMapper" >
  <resultMap id="BaseResultMap" type="com.tj720.admin.model.MipTopic" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    <id column="id" property="id" jdbcType="VARCHAR" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="publish_org" property="publishOrg" jdbcType="VARCHAR" />
    <result column="publish_time" property="publishTime" jdbcType="TIMESTAMP" />
    <result column="status" property="status" jdbcType="VARCHAR" />
    <result column="label" property="label" jdbcType="VARCHAR" />
    <result column="exhibition_hall" property="exhibitionHall" jdbcType="VARCHAR" />
    <result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
    <result column="introduction" property="introduction" jdbcType="VARCHAR" />
    <result column="icon_url" property="iconUrl" jdbcType="VARCHAR" />
    <result column="created_time" property="createdTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="palyNum" property="palyNum" jdbcType="INTEGER" />
    <result column="type" property="type" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    id, name, publish_org, publish_time, status, label, exhibition_hall, start_time, 
    end_time, introduction, icon_url, created_time, update_time, palyNum, type
  </sql>
  <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.tj720.admin.model.MipTopicExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from mip_topic
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    select 
    <include refid="Base_Column_List" />
    from mip_topic
    where id = #{id,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    delete from mip_topic
    where id = #{id,jdbcType=VARCHAR}
  </delete>
  <delete id="deleteByExample" parameterType="com.tj720.admin.model.MipTopicExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    delete from mip_topic
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.tj720.admin.model.MipTopic" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    insert into mip_topic (id, name, publish_org, 
      publish_time, status, label, 
      exhibition_hall, start_time, end_time, 
      introduction, icon_url, created_time, 
      update_time, palyNum, type)
    values (#{id,jdbcType=VARCHAR}, #{name,jdbcType=VARCHAR}, #{publishOrg,jdbcType=VARCHAR}, 
      #{publishTime,jdbcType=TIMESTAMP}, #{status,jdbcType=VARCHAR}, #{label,jdbcType=VARCHAR}, 
      #{exhibitionHall,jdbcType=VARCHAR}, #{startTime,jdbcType=TIMESTAMP}, #{endTime,jdbcType=TIMESTAMP}, 
      #{introduction,jdbcType=VARCHAR}, #{iconUrl,jdbcType=VARCHAR}, #{createdTime,jdbcType=TIMESTAMP}, 
      #{updateTime,jdbcType=TIMESTAMP}, #{palyNum,jdbcType=INTEGER}, #{type,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.tj720.admin.model.MipTopic" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    insert into mip_topic
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="name != null" >
        name,
      </if>
      <if test="publishOrg != null" >
        publish_org,
      </if>
      <if test="publishTime != null" >
        publish_time,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="label != null" >
        label,
      </if>
      <if test="exhibitionHall != null" >
        exhibition_hall,
      </if>
      <if test="startTime != null" >
        start_time,
      </if>
      <if test="endTime != null" >
        end_time,
      </if>
      <if test="introduction != null" >
        introduction,
      </if>
      <if test="iconUrl != null" >
        icon_url,
      </if>
      <if test="createdTime != null" >
        created_time,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
      <if test="palyNum != null" >
        palyNum,
      </if>
      <if test="type != null" >
        type,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="name != null" >
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="publishOrg != null" >
        #{publishOrg,jdbcType=VARCHAR},
      </if>
      <if test="publishTime != null" >
        #{publishTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        #{status,jdbcType=VARCHAR},
      </if>
      <if test="label != null" >
        #{label,jdbcType=VARCHAR},
      </if>
      <if test="exhibitionHall != null" >
        #{exhibitionHall,jdbcType=VARCHAR},
      </if>
      <if test="startTime != null" >
        #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null" >
        #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="introduction != null" >
        #{introduction,jdbcType=VARCHAR},
      </if>
      <if test="iconUrl != null" >
        #{iconUrl,jdbcType=VARCHAR},
      </if>
      <if test="createdTime != null" >
        #{createdTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="palyNum != null" >
        #{palyNum,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        #{type,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.tj720.admin.model.MipTopicExample" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    select count(*) from mip_topic
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    update mip_topic
    <set >
      <if test="record.id != null" >
        id = #{record.id,jdbcType=VARCHAR},
      </if>
      <if test="record.name != null" >
        name = #{record.name,jdbcType=VARCHAR},
      </if>
      <if test="record.publishOrg != null" >
        publish_org = #{record.publishOrg,jdbcType=VARCHAR},
      </if>
      <if test="record.publishTime != null" >
        publish_time = #{record.publishTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.status != null" >
        status = #{record.status,jdbcType=VARCHAR},
      </if>
      <if test="record.label != null" >
        label = #{record.label,jdbcType=VARCHAR},
      </if>
      <if test="record.exhibitionHall != null" >
        exhibition_hall = #{record.exhibitionHall,jdbcType=VARCHAR},
      </if>
      <if test="record.startTime != null" >
        start_time = #{record.startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.endTime != null" >
        end_time = #{record.endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.introduction != null" >
        introduction = #{record.introduction,jdbcType=VARCHAR},
      </if>
      <if test="record.iconUrl != null" >
        icon_url = #{record.iconUrl,jdbcType=VARCHAR},
      </if>
      <if test="record.createdTime != null" >
        created_time = #{record.createdTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.updateTime != null" >
        update_time = #{record.updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.palyNum != null" >
        palyNum = #{record.palyNum,jdbcType=INTEGER},
      </if>
      <if test="record.type != null" >
        type = #{record.type,jdbcType=VARCHAR},
      </if>
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    update mip_topic
    set id = #{record.id,jdbcType=VARCHAR},
      name = #{record.name,jdbcType=VARCHAR},
      publish_org = #{record.publishOrg,jdbcType=VARCHAR},
      publish_time = #{record.publishTime,jdbcType=TIMESTAMP},
      status = #{record.status,jdbcType=VARCHAR},
      label = #{record.label,jdbcType=VARCHAR},
      exhibition_hall = #{record.exhibitionHall,jdbcType=VARCHAR},
      start_time = #{record.startTime,jdbcType=TIMESTAMP},
      end_time = #{record.endTime,jdbcType=TIMESTAMP},
      introduction = #{record.introduction,jdbcType=VARCHAR},
      icon_url = #{record.iconUrl,jdbcType=VARCHAR},
      created_time = #{record.createdTime,jdbcType=TIMESTAMP},
      update_time = #{record.updateTime,jdbcType=TIMESTAMP},
      palyNum = #{record.palyNum,jdbcType=INTEGER},
      type = #{record.type,jdbcType=VARCHAR}
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.tj720.admin.model.MipTopic" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    update mip_topic
    <set >
      <if test="name != null" >
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="publishOrg != null" >
        publish_org = #{publishOrg,jdbcType=VARCHAR},
      </if>
      <if test="publishTime != null" >
        publish_time = #{publishTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=VARCHAR},
      </if>
      <if test="label != null" >
        label = #{label,jdbcType=VARCHAR},
      </if>
      <if test="exhibitionHall != null" >
        exhibition_hall = #{exhibitionHall,jdbcType=VARCHAR},
      </if>
      <if test="startTime != null" >
        start_time = #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null" >
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="introduction != null" >
        introduction = #{introduction,jdbcType=VARCHAR},
      </if>
      <if test="iconUrl != null" >
        icon_url = #{iconUrl,jdbcType=VARCHAR},
      </if>
      <if test="createdTime != null" >
        created_time = #{createdTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="palyNum != null" >
        palyNum = #{palyNum,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        type = #{type,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.tj720.admin.model.MipTopic" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 08 15:42:19 CST 2018.
    -->
    update mip_topic
    set name = #{name,jdbcType=VARCHAR},
      publish_org = #{publishOrg,jdbcType=VARCHAR},
      publish_time = #{publishTime,jdbcType=TIMESTAMP},
      status = #{status,jdbcType=VARCHAR},
      label = #{label,jdbcType=VARCHAR},
      exhibition_hall = #{exhibitionHall,jdbcType=VARCHAR},
      start_time = #{startTime,jdbcType=TIMESTAMP},
      end_time = #{endTime,jdbcType=TIMESTAMP},
      introduction = #{introduction,jdbcType=VARCHAR},
      icon_url = #{iconUrl,jdbcType=VARCHAR},
      created_time = #{createdTime,jdbcType=TIMESTAMP},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      palyNum = #{palyNum,jdbcType=INTEGER},
      type = #{type,jdbcType=VARCHAR}
    where id = #{id,jdbcType=VARCHAR}
  </update>
  
  <select id="selectListByKey" resultType="com.tj720.admin.model.MipTopic" >
    select
    	a.id, max(a.name) as name,a.icon_url as iconUrl, max(a.publish_org) as publishOrg, max(c.name) as publishOrgName, max(a.publish_time) as publishTime ,
    	max(a.status) as status, count(b.id) as collectionCount, max(a.palyNum) as palyNum, max(a.label) as label, max(d.name) as type
    from mip_topic a
    left join (select b1.* from mip_topic_collection b1, mip_open_culturalrelic_info b2 where b1.collection_id = b2.id <![CDATA[ and b2.status > 0 ]]> ) b on(a.id=b.topic_id) 
    left join mip_organization c on(a.publish_org = c.id)
    left join mip_topic_type d on(d.id = a.type)
    where 1=1
	and (a.publish_org = #{orgId}
	<if test="orgIdList != null and orgIdList.size() > 0">
    or (a.publish_org in
	    <foreach collection="orgIdList" item="item" open="(" close=")" separator="," >
	   		#{item}
		</foreach>
		and a.`status` = '2')
    </if>
	)
	<if test="museumId != null and museumId != ''">
		and a.publish_org = #{museumId}
	</if>
    <![CDATA[ and a.status <> 0  ]]> 
    <if test="key != null and key != ''">
    	and (a.name like concat('%',#{key},'%')
    	or  c.name like concat('%',#{key},'%')
    	or  a.label like concat('%',#{key},'%'))
    </if>
    <if test="status != null and status != ''">
    	and a.status = #{status}
    </if>
    group by a.id
    order by a.created_time desc
    <if test=" pageSize != 0">
    	<if test=" startRow == 0">
			limit #{pageSize}
    	</if>
    	<if test=" startRow != 0">
			limit #{startRow},#{pageSize}
    	</if>
	</if>
  </select>
  <select id="countListByKey" resultType="java.lang.Integer" >
    select count(t.id) from (select
    	a.id
    from mip_topic a
    left join mip_topic_collection b on(a.id=b.topic_id) 
    left join mip_organization c on(a.publish_org = c.id)
    where 1=1
	and (a.publish_org = #{orgId}
	<if test="orgIdList != null and orgIdList.size() > 0">
    or (a.publish_org in
	    <foreach collection="orgIdList" item="item" open="(" close=")" separator="," >
	   		#{item}
		</foreach>
		and a.`status` = '2')
    </if>
	)
	<if test="museumId != null and museumId != ''">
		and a.publish_org = #{museumId}
	</if>
    <![CDATA[ and a.status <> 0  ]]> 
    <if test="key != null and key != ''">
    	and (a.name like concat('%',#{key},'%')
    	or  c.name like concat('%',#{key},'%')
    	or  a.label like concat('%',#{key},'%'))
    </if>
    <if test="status != null and status != ''">
    	and a.status = #{status}
    </if>
    group by a.id) t
  </select>
  
  
  <select id="getListByOrgId" resultType="com.tj720.admin.model.MipTopic" >
    select
    	a.id as id,a.palyNum, a.name as name ,a.publish_org as publishOrg,c.name as publishOrgName,a.publish_time as publishTime ,a.icon_url as iconUrl,
    	a.status as status, count(b.id) as collectionCount
    from mip_topic a
    left join mip_topic_collection b on(a.id=b.topic_id) 
    left join mip_organization c on(a.publish_org = c.id)
    where 1=1  		 
    <if test="orgId != null and orgId != ''">
    	and a.publish_org = #{orgId}
    </if>  
    group by a.id
    order by a.created_time DESC
  </select>
  <select id="getListByOrgIdAndTopicId" resultType="com.tj720.admin.model.MipTopic" >
    select
        a.id as id,a.palyNum, a.name as name ,a.publish_org as publishOrg,c.name as publishOrgName,a.publish_time as publishTime ,a.icon_url as iconUrl,
        a.status as status, count(b.id) as collectionCount
    from mip_topic a
    left join mip_topic_collection b on(a.id=b.topic_id) 
    left join mip_organization c on(a.publish_org = c.id)
    where 1=1        
    <if test="topicId != null and topicId != ''">
        and a.id = #{topicId}
    </if>  
    <if test="orgId != null and orgId != ''">
        and a.publish_org = #{orgId}
    </if>  
    group by a.id
    order by a.created_time DESC
  </select>
  
  <select id="getCollectionList" resultType="com.tj720.admin.dto.MipTopicCollectionDto" >
    select g.*, h.url from (select b.id, left(CONCAT(b.picture_ids,','), LOCATE(',',CONCAT(b.picture_ids,','))-1) as pictureId, b.gs_No as gsNo, b.name, e.`name` as collectionUnit,
    f.name as collectionLevel, c.`name` as yearType, d.`name` as collectionsCategory
    from mip_open_culturalrelic_info b
    left join mip_year_type c on(b.year_type=c.id)
		left join mip_collection_category d on(d.id=b.collections_category)
		left join mip_organization e on(e.id=b.collection_unit)
		left join mip_collection_level f on(f.id = b.collection_level)
	    where 1=1
	    <if test="orgId != null and orgId.size() > 0">
		    and b.collection_unit in 
		    <foreach collection="orgId" item="item" open="(" close=")" separator="," >
			   #{item.id}
			</foreach>
	    </if>
	    <if test="search.name != null and search.name != ''">
	    	and b.name like '%${search.name}%'
	    </if>
	    <if test="search.collectionsCategory != null and search.collectionsCategory != ''">
	    	and b.collections_category=#{search.collectionsCategory}
	    </if>
	    <if test="search.yearType != null and search.yearType != ''">
	    	and b.year_type=#{search.yearType}
	    </if>
		and b.id not in(select f.collection_id from mip_topic_collection f where f.topic_id = #{topicId})) g
	left join mip_picture h on(g.pictureId=h.id)
	<if test=" pageSize != 0">
    	<if test=" startRow == 0">
			limit #{pageSize}
    	</if>
    	<if test=" startRow != 0">
			limit #{startRow},#{pageSize}
    	</if>
	</if>
  </select>
  
  <select id="countCollectionList" resultType="java.lang.Integer" >
    select count(*)
    from mip_open_culturalrelic_info b
	    where 1=1
	    <if test="orgId != null and orgId.size() > 0">
		    and b.collection_unit in 
		    <foreach collection="orgId" item="item" open="(" close=")" separator="," >
			   #{item.id}
			</foreach>
	    </if>
		and b.id not in(select f.collection_id from mip_topic_collection f where f.topic_id = #{topicId})
  </select>
  
</mapper>